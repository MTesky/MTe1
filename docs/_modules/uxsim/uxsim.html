<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>uxsim.uxsim &mdash; UXsim v1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
 
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111714220-1"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-111714220-1');
</script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            UXsim
          </a>
              <div class="version">
                v1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mechanism.html">Simulation mechanism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tech_ref.html">Technical reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">UXsim</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">uxsim.uxsim</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for uxsim.uxsim</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Macroscopic/mesoscopic traffic flow simulator in a network.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">csv</span><span class="o">,</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageFont</span><span class="p">,</span> <span class="n">ImageOps</span>
<span class="kn">from</span> <span class="nn">PIL.Image</span> <span class="kn">import</span> <span class="n">Resampling</span><span class="p">,</span> <span class="n">Transpose</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span> <span class="k">as</span> <span class="n">ddict</span>
<span class="kn">from</span> <span class="nn">.utils</span>  <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>

<span class="kn">from</span> <span class="nn">scipy.sparse.csgraph</span> <span class="kn">import</span> <span class="n">floyd_warshall</span>

<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;font.family&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;monospace&quot;</span>

<span class="c1"># ノードクラス</span>
<div class="viewcode-block" id="Node"><a class="viewcode-back" href="../../uxsim.html#uxsim.Node">[docs]</a><span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Node in a network.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Node.__init__"><a class="viewcode-back" href="../../_autosummary/uxsim.Node.html#uxsim.Node.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">signal_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">flow_capacity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a node</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        W : object</span>
<span class="sd">            The world to which the node belongs.</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the node.</span>
<span class="sd">        x : float</span>
<span class="sd">            The x-coordinate of the node (for visualization purposes).</span>
<span class="sd">        y : float</span>
<span class="sd">            The y-coordinate of the node (for visualization purposes).</span>
<span class="sd">        signal : list of int, optional</span>
<span class="sd">            A list representing the signal at the node. Default is [0], representing no signal.</span>
<span class="sd">            If a signal is present, the list contains the green times for each group.</span>
<span class="sd">            For example, `signal`=[60, 10, 50, 5] means that this signal has 4 phases, and green time for the 1st group is 60 s.</span>
<span class="sd">        signal_offset : float, optional</span>
<span class="sd">            The offset of the signal. Default is 0.</span>
<span class="sd">        flow_capacity : float, optional</span>
<span class="sd">            The maximum flow capacity of the node. Default is None, meaning infinite capacity.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        signal_phase : int</span>
<span class="sd">            The phase of current signal. Links that have the same `signal_group` have a green signal.</span>
<span class="sd">        signal_t : float</span>
<span class="sd">            The elapsed time since the current signal phase started. When it is larger than `Link.signal[Link.signal_phase]`, the phase changes to the next one.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">s</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>
        <span class="c1">#ノード位置（可視化用）</span>
        <span class="n">s</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">s</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

        <span class="c1">#流入・流出リンク</span>
        <span class="n">s</span><span class="o">.</span><span class="n">inlinks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">s</span><span class="o">.</span><span class="n">outlinks</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1">#リンク間遷移リクエスト（デマンド）</span>
        <span class="n">s</span><span class="o">.</span><span class="n">incoming_vehicles</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#発生車両流入待ち行列（vertical queue）</span>
        <span class="n">s</span><span class="o">.</span><span class="n">generation_queue</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>

        <span class="c1">#信号交差点</span>
        <span class="c1">#signal=[0]であれば信号無し</span>
        <span class="c1">#信号ありにするときはsignal=[group0の青時間，group1の青時間，...]とする</span>
        <span class="n">s</span><span class="o">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">signal</span>
        <span class="n">s</span><span class="o">.</span><span class="n">signal_phase</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">signal_t</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">signal_offset</span> <span class="o">=</span> <span class="n">signal_offset</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">signal_offset</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">signal</span> <span class="o">!=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">signal_phase</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">signal_t</span> <span class="o">=</span> <span class="n">offset</span>
                    <span class="k">break</span>
                <span class="n">offset</span> <span class="o">-=</span> <span class="n">s</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">signal</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">s</span><span class="o">.</span><span class="n">signal_log</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#流量制限</span>
        <span class="k">if</span> <span class="n">flow_capacity</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity</span> <span class="o">=</span> <span class="n">flow_capacity</span>
            <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity_remain</span> <span class="o">=</span> <span class="n">flow_capacity</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity_remain</span> <span class="o">=</span> <span class="mi">99999999999</span>

        <span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Node </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

<div class="viewcode-block" id="Node.signal_control"><a class="viewcode-back" href="../../uxsim.html#uxsim.Node.signal_control">[docs]</a>    <span class="k">def</span> <span class="nf">signal_control</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the signal timings for a traffic signal node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">signal_t</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">signal_phase</span><span class="p">]:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">signal_phase</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">s</span><span class="o">.</span><span class="n">signal_t</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">signal_phase</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">signal</span><span class="p">):</span>
                <span class="n">s</span><span class="o">.</span><span class="n">signal_phase</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">signal_t</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>

        <span class="n">s</span><span class="o">.</span><span class="n">signal_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">signal_phase</span><span class="p">)</span></div>

<div class="viewcode-block" id="Node.flow_capacity_update"><a class="viewcode-back" href="../../uxsim.html#uxsim.Node.flow_capacity_update">[docs]</a>    <span class="k">def</span> <span class="nf">flow_capacity_update</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        flow capacity updates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity_remain</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity_remain</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span></div>

<div class="viewcode-block" id="Node.generate"><a class="viewcode-back" href="../../uxsim.html#uxsim.Node.generate">[docs]</a>    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Departs vehicles from the waiting queue.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If there are vehicles in the generation queue of the node, this method attempts to depart a vehicle to one of the outgoing links.</span>
<span class="sd">        The choice of the outgoing link is based on the vehicle&#39;s route preference for each link. Once a vehicle is departed, it is removed from the generation queue, added to the list of vehicles on the chosen link, and its state is set to &quot;run&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">generation_queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">veh</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">generation_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">outlinks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">outlinks</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outlinks</span><span class="p">):</span>
                <span class="n">preference</span> <span class="o">=</span> <span class="p">[</span><span class="n">veh</span><span class="o">.</span><span class="n">route_pref</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">outlinks</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">preference</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">outlink</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">outlinks</span><span class="p">,</span> <span class="n">preference</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outlink</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">outlinks</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">outlink</span><span class="o">.</span><span class="n">delta</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">)</span> <span class="ow">and</span> <span class="n">outlink</span><span class="o">.</span><span class="n">capacity_in_remain</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">:</span>
                    <span class="c1">#受け入れ可能な場合，リンク優先度に応じて選択</span>
                    <span class="n">veh</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">generation_queue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>

                    <span class="n">veh</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;run&quot;</span>
                    <span class="n">veh</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">outlink</span>
                    <span class="n">veh</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">veh</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">outlink</span><span class="o">.</span><span class="n">u</span> <span class="c1">#端部の挙動改善</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_RUNNING</span><span class="p">[</span><span class="n">veh</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">veh</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">veh</span><span class="o">.</span><span class="n">leader</span> <span class="o">=</span> <span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">veh</span><span class="o">.</span><span class="n">leader</span><span class="o">.</span><span class="n">follower</span> <span class="o">=</span> <span class="n">veh</span>

                    <span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">veh</span><span class="p">)</span>

                    <span class="n">outlink</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
                    <span class="n">veh</span><span class="o">.</span><span class="n">link_arrival_time</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>

                    <span class="n">outlink</span><span class="o">.</span><span class="n">capacity_in_remain</span> <span class="o">-=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span></div>

<div class="viewcode-block" id="Node.transfer"><a class="viewcode-back" href="../../uxsim.html#uxsim.Node.transfer">[docs]</a>    <span class="k">def</span> <span class="nf">transfer</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transfers vehicles between links at the node.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method handles the transfer of vehicles from one link to another at the node.</span>
<span class="sd">        A vehicle is eligible for transfer if:</span>
<span class="sd">        - The next link it intends to move to has space.</span>
<span class="sd">        - The vehicle has the right signal phase to proceed.</span>
<span class="sd">        - The current link has enough capacity to allow the vehicle to exit.</span>
<span class="sd">        - The node capacity is not exceeded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">outlink</span> <span class="ow">in</span> <span class="p">{</span><span class="n">veh</span><span class="o">.</span><span class="n">route_next_link</span> <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">incoming_vehicles</span> <span class="k">if</span> <span class="n">veh</span><span class="o">.</span><span class="n">route_next_link</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">}:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">outlink</span><span class="o">.</span><span class="n">delta</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">)</span> <span class="ow">and</span> <span class="n">outlink</span><span class="o">.</span><span class="n">capacity_in_remain</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity_remain</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">:</span>
                <span class="c1">#受け入れ可能かつ流出可能の場合，リンク優先度に応じて選択</span>
                <span class="n">vehs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">veh</span> <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">incoming_vehicles</span> 
                    <span class="k">if</span> <span class="n">veh</span><span class="o">.</span><span class="n">route_next_link</span> <span class="o">==</span> <span class="n">outlink</span> <span class="ow">and</span>
                      <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">signal_phase</span> <span class="ow">in</span> <span class="n">veh</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">signal_group</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">signal</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> 
                      <span class="n">veh</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">capacity_out_remain</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vehs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">veh</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">vehs</span><span class="p">,</span> <span class="p">[</span><span class="n">veh</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">merge_priority</span> <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">vehs</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">inlink</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">link</span>

                <span class="c1">#累積台数関連更新</span>
                <span class="n">inlink</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
                <span class="n">outlink</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
                <span class="n">inlink</span><span class="o">.</span><span class="n">traveltime_actual</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">link_arrival_time</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">):]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span> <span class="o">-</span> <span class="n">veh</span><span class="o">.</span><span class="n">link_arrival_time</span> <span class="c1">#自分の流入時刻より後の実旅行時間も今の実旅行時間で仮決め．後に流出した車両が上書きする前提</span>

                <span class="n">veh</span><span class="o">.</span><span class="n">link_arrival_time</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>

                <span class="n">inlink</span><span class="o">.</span><span class="n">capacity_out_remain</span> <span class="o">-=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
                <span class="n">outlink</span><span class="o">.</span><span class="n">capacity_in_remain</span> <span class="o">-=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity_remain</span> <span class="o">-=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>

                <span class="c1">#リンク間遷移実行</span>
                <span class="n">inlink</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
                <span class="n">veh</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">outlink</span>
                <span class="n">veh</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">veh</span><span class="o">.</span><span class="n">follower</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">veh</span><span class="o">.</span><span class="n">follower</span><span class="o">.</span><span class="n">leader</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">veh</span><span class="o">.</span><span class="n">follower</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">veh</span><span class="o">.</span><span class="n">leader</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">):</span>
                    <span class="n">veh</span><span class="o">.</span><span class="n">leader</span> <span class="o">=</span> <span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">veh</span><span class="o">.</span><span class="n">leader</span><span class="o">.</span><span class="n">follower</span> <span class="o">=</span> <span class="n">veh</span>

                <span class="c1">#走り残し処理</span>
                <span class="n">x_next</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">move_remain</span><span class="o">*</span><span class="n">outlink</span><span class="o">.</span><span class="n">u</span><span class="o">/</span><span class="n">inlink</span><span class="o">.</span><span class="n">u</span>
                <span class="k">if</span> <span class="n">veh</span><span class="o">.</span><span class="n">leader</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">x_cong</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">leader</span><span class="o">.</span><span class="n">x_old</span> <span class="o">-</span> <span class="n">veh</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">delta</span><span class="o">*</span><span class="n">veh</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
                    <span class="k">if</span> <span class="n">x_cong</span> <span class="o">&lt;</span> <span class="n">veh</span><span class="o">.</span><span class="n">x</span><span class="p">:</span>
                        <span class="n">x_cong</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">x</span>
                    <span class="k">if</span> <span class="n">x_next</span> <span class="o">&gt;</span> <span class="n">x_cong</span><span class="p">:</span>
                        <span class="n">x_next</span> <span class="o">=</span> <span class="n">x_cong</span>
                    <span class="k">if</span> <span class="n">x_next</span> <span class="o">&gt;=</span> <span class="n">outlink</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
                        <span class="n">x_next</span> <span class="o">=</span> <span class="n">outlink</span><span class="o">.</span><span class="n">length</span>
                <span class="n">veh</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x_next</span>

                <span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">veh</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">incoming_vehicles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">veh</span><span class="p">)</span>

        <span class="n">s</span><span class="o">.</span><span class="n">incoming_vehicles</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="Node.update"><a class="viewcode-back" href="../../uxsim.html#uxsim.Node.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make necessary updates when the timestep is incremented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">signal_control</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity_update</span><span class="p">()</span></div></div>

<span class="c1"># リンククラス</span>
<div class="viewcode-block" id="Link"><a class="viewcode-back" href="../../uxsim.html#uxsim.Link">[docs]</a><span class="k">class</span> <span class="nc">Link</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Link in a network.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Link.__init__"><a class="viewcode-back" href="../../_autosummary/uxsim.Link.html#uxsim.Link.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">start_node</span><span class="p">,</span> <span class="n">end_node</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">free_flow_speed</span><span class="p">,</span> <span class="n">jam_density</span><span class="p">,</span> <span class="n">merge_priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">signal_group</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">capacity_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">capacity_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eular_dx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a link</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        W : object</span>
<span class="sd">            The network to which the link belongs.</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the link.</span>
<span class="sd">        start_node : str</span>
<span class="sd">            The name of the start node of the link.</span>
<span class="sd">        end_node : str</span>
<span class="sd">            The name of the end node of the link.</span>
<span class="sd">        length : float</span>
<span class="sd">            The length of the link.</span>
<span class="sd">        free_flow_speed : float</span>
<span class="sd">            The free flow speed on the link.</span>
<span class="sd">        jam_density : float</span>
<span class="sd">            The jam density on the link.</span>
<span class="sd">        merge_priority : float, optional</span>
<span class="sd">            The priority of the link when merging at the downstream node, default is 1.</span>
<span class="sd">        signal_group : int or list, optional</span>
<span class="sd">            The signal group to which the link belongs, default is 0. If `signal_group` is int, say 0, it becomes green if `end_node.signal_phase` is 0.  the If `signal_group` is list, say [0,1], it becomes green if the `end_node.signal_phase` is 0 or 1.</span>
<span class="sd">        capacity_out : float, optional</span>
<span class="sd">            The capacity out of the link, default is calculated based on other parameters.</span>
<span class="sd">        capacity_in : float, optional</span>
<span class="sd">            The capacity into the link, default is calculated based on other parameters.</span>
<span class="sd">        eular_dx : float, optional</span>
<span class="sd">            The default space aggregation size for link traffic state computation, default is None. If None, the global eular_dx value is used.</span>
<span class="sd">        attribute : any, optinonal</span>
<span class="sd">            Additional (meta) attributes defined by users.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        speed : float</span>
<span class="sd">            Average speed of traffic on the link.</span>
<span class="sd">        density : float</span>
<span class="sd">            Density of traffic on the link.</span>
<span class="sd">        flow : float</span>
<span class="sd">            Flow of traffic on the link.</span>
<span class="sd">        num_vehicles : float</span>
<span class="sd">            Number of vehicles on the link.</span>
<span class="sd">        num_vehicles_queue : float</span>
<span class="sd">            Number of slow vehicles (due to congestion) on the link.</span>
<span class="sd">        free_flow_speed : float</span>
<span class="sd">            Free flow speed of the link.</span>
<span class="sd">        jam_density : float</span>
<span class="sd">            Jam density of the link.</span>
<span class="sd">        capacity_out : float</span>
<span class="sd">            Capacity for outflow from the link.</span>
<span class="sd">        capacity_in : float</span>
<span class="sd">            Capacity for inflow to the link.</span>
<span class="sd">        merge_priority : float</span>
<span class="sd">            The priority of the link when merging at the downstream node.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The `capacity_out` and `capacity_in` parameters are used to set the capacities, and if not provided, they are calculated based on other parameters.</span>
<span class="sd">        Real-time link status for external reference is maintained with attributes `speed`, `density`, `flow`, `num_vehicles`, and `num_vehicles_queue`.</span>
<span class="sd">        Some of the traffic flow model parameters can be altered during simulation by changing `free_flow_speed`, `jam_density`, `capacity_out`, `capacity_in`, and `merge_priority`.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">s</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>
        <span class="c1">#起点・終点ノード</span>
        <span class="n">s</span><span class="o">.</span><span class="n">start_node</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">start_node</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">end_node</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">end_node</span><span class="p">)</span>

        <span class="c1">#リンク長</span>
        <span class="n">s</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span>

        <span class="c1">#フローモデルパラメータ</span>
        <span class="n">s</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">free_flow_speed</span>
        <span class="n">s</span><span class="o">.</span><span class="n">kappa</span> <span class="o">=</span> <span class="n">jam_density</span>
        <span class="n">s</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">REACTION_TIME</span>
        <span class="n">s</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">tau</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">kappa</span>
        <span class="n">s</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">w</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">kappa</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">u</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">kappa</span>

        <span class="c1">#合流時優先度</span>
        <span class="n">s</span><span class="o">.</span><span class="n">merge_priority</span> <span class="o">=</span> <span class="n">merge_priority</span>

        <span class="c1">#リンク内車両一覧</span>
        <span class="n">s</span><span class="o">.</span><span class="n">vehicles</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>

        <span class="c1">#旅行時間</span>
        <span class="n">s</span><span class="o">.</span><span class="n">traveltime_instant</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#経路選択補正</span>
        <span class="n">s</span><span class="o">.</span><span class="n">route_choice_penalty</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#累積図関係</span>
        <span class="n">s</span><span class="o">.</span><span class="n">cum_arrival</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">cum_departure</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">traveltime_actual</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#信号関係</span>
        <span class="n">s</span><span class="o">.</span><span class="n">signal_group</span> <span class="o">=</span> <span class="n">signal_group</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">signal_group</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">signal_group</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">signal_group</span><span class="p">]</span>

        <span class="c1">#流出容量</span>
        <span class="n">s</span><span class="o">.</span><span class="n">capacity_out</span> <span class="o">=</span> <span class="n">capacity_out</span>
        <span class="k">if</span> <span class="n">capacity_out</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">capacity_out</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity</span><span class="o">*</span><span class="mi">2</span>
            <span class="c1">#todo_later: capacity_outは微妙にバグがあるらしい（多分離散化誤差）．少なくとも未設定時にはバグが顕在化しないように2倍にしている</span>
        <span class="n">s</span><span class="o">.</span><span class="n">capacity_out_remain</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity_out</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>

        <span class="c1">#流入容量</span>
        <span class="n">s</span><span class="o">.</span><span class="n">capacity_in</span> <span class="o">=</span> <span class="n">capacity_in</span>
        <span class="k">if</span> <span class="n">capacity_in</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">capacity_in</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity</span><span class="o">*</span><span class="mi">2</span>
            <span class="c1">#todo_later: capacity_inは微妙にバグがあるらしい（多分離散化誤差）．少なくとも未設定時にはバグが顕在化しないように2倍にしている</span>
        <span class="n">s</span><span class="o">.</span><span class="n">capacity_in_remain</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity_in</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>

        <span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">outlinks</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
        <span class="n">s</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">inlinks</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>

        <span class="n">s</span><span class="o">.</span><span class="n">attribute</span> <span class="o">=</span> <span class="n">attribute</span>

        <span class="c1">#リアルタイムリンク状態（外部から参照する用）</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_speed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">#リンク全体の平均速度</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_density</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_flow</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">#車両数</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles_queue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">#自由流速度未満の車両数</span>

        <span class="c1">#より正確な車両軌跡</span>
        <span class="n">s</span><span class="o">.</span><span class="n">tss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">xss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">eular_dx</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">eular_dx</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">10</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">eular_dx</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">eular_dx</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Link </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

<div class="viewcode-block" id="Link.init_after_tmax_fix"><a class="viewcode-back" href="../../uxsim.html#uxsim.Link.init_after_tmax_fix">[docs]</a>    <span class="k">def</span> <span class="nf">init_after_tmax_fix</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initalization before simulation execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#Euler型交通状態</span>
        <span class="n">s</span><span class="o">.</span><span class="n">edie_dt</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">EULAR_DT</span>
        <span class="n">s</span><span class="o">.</span><span class="n">edie_dx</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">eular_dx</span>
        <span class="n">s</span><span class="o">.</span><span class="n">k_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">edie_dt</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">edie_dx</span><span class="p">)])</span>
        <span class="n">s</span><span class="o">.</span><span class="n">q_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">k_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">v_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">k_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">tn_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">k_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">dn_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">k_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">an</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">edie_dt</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">edie_dx</span>

        <span class="c1">#累積</span>
        <span class="n">s</span><span class="o">.</span><span class="n">traveltime_actual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">u</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span><span class="p">)])</span></div>

<div class="viewcode-block" id="Link.update"><a class="viewcode-back" href="../../uxsim.html#uxsim.Link.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make necessary updates when the timestep is incremented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">in_out_flow_constraint</span><span class="p">()</span>

        <span class="n">s</span><span class="o">.</span><span class="n">set_traveltime_instant</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">cum_arrival</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">cum_departure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">s</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1">#リアルタイム状態リセット</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_speed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_density</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_flow</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles_queue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span></div>

<div class="viewcode-block" id="Link.in_out_flow_constraint"><a class="viewcode-back" href="../../uxsim.html#uxsim.Link.in_out_flow_constraint">[docs]</a>    <span class="k">def</span> <span class="nf">in_out_flow_constraint</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Link capacity updates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#リンク流入出率を流出容量以下にするための処理</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity_out_remain</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">capacity_out_remain</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity_out</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity_in_remain</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">capacity_in_remain</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity_in</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span></div>

<div class="viewcode-block" id="Link.set_traveltime_instant"><a class="viewcode-back" href="../../uxsim.html#uxsim.Link.set_traveltime_instant">[docs]</a>    <span class="k">def</span> <span class="nf">set_traveltime_instant</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute instantanious travel time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">speed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">u</span><span class="o">/</span><span class="mi">100</span><span class="p">))</span></div>

<div class="viewcode-block" id="Link.arrival_count"><a class="viewcode-back" href="../../uxsim.html#uxsim.Link.arrival_count">[docs]</a>    <span class="k">def</span> <span class="nf">arrival_count</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get cumulative vehicle count of arrival to this link on time t</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t : float</span>
<span class="sd">            Time in seconds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The cumulative arrival vehicle count.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">//</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span></div>

<div class="viewcode-block" id="Link.departure_count"><a class="viewcode-back" href="../../uxsim.html#uxsim.Link.departure_count">[docs]</a>    <span class="k">def</span> <span class="nf">departure_count</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get cumulative vehicle count of departure from this link on time t</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t : float</span>
<span class="sd">            Time in seconds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The cumulative departure vehicle count.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">//</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span></div>

<div class="viewcode-block" id="Link.instant_travel_time"><a class="viewcode-back" href="../../uxsim.html#uxsim.Link.instant_travel_time">[docs]</a>    <span class="k">def</span> <span class="nf">instant_travel_time</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get instantanious travel time of this link on time t</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t : float</span>
<span class="sd">            Time in seconds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The instantanious travel time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">//</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span></div>

<div class="viewcode-block" id="Link.actual_travel_time"><a class="viewcode-back" href="../../uxsim.html#uxsim.Link.actual_travel_time">[docs]</a>    <span class="k">def</span> <span class="nf">actual_travel_time</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get actual travel time of vehicle who enters this link on time t. Note that small error may occur due to fractional processing.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t : float</span>
<span class="sd">            Time in seconds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The actual travel time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">//</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">traveltime_actual</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">traveltime_actual</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">traveltime_actual</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">traveltime_actual</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span></div>

    <span class="c1">#getter/setter</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">speed</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">_speed</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">vehicles</span><span class="p">):</span>
                <span class="n">s</span><span class="o">.</span><span class="n">_speed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">([</span><span class="n">veh</span><span class="o">.</span><span class="n">v</span> <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">vehicles</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">_speed</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">u</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">_speed</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">density</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">_density</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">_density</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">num_vehicles</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">length</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">_density</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">flow</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">_flow</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">_flow</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">density</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">speed</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">_flow</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_vehicles</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">vehicles</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_vehicles_queue</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles_queue</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles_queue</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">veh</span><span class="o">.</span><span class="n">v</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">u</span> <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">vehicles</span><span class="p">])</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles_queue</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">free_flow_speed</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">u</span>

    <span class="nd">@free_flow_speed</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">free_flow_speed</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">new_value</span>
            <span class="n">s</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">tau</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">kappa</span>
            <span class="n">s</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">w</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">kappa</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">u</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">kappa</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ignored negative free_flow_speed at </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">jam_density</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">kappa</span>

    <span class="nd">@jam_density</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">jam_density</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">kappa</span> <span class="o">=</span> <span class="n">new_value</span>
            <span class="n">s</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">tau</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">kappa</span>
            <span class="n">s</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">w</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">kappa</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">u</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">kappa</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ignored negative jam_density at </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span></div>


<span class="c1"># 車両クラス</span>
<div class="viewcode-block" id="Vehicle"><a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle">[docs]</a><span class="k">class</span> <span class="nc">Vehicle</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vehicle or platoon in a network.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Vehicle.__init__"><a class="viewcode-back" href="../../_autosummary/uxsim.Vehicle.html#uxsim.Vehicle.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">departure_time</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">route_pref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">route_choice_principle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">links_prefer</span><span class="o">=</span><span class="p">[],</span> <span class="n">links_avoid</span><span class="o">=</span><span class="p">[],</span> <span class="n">trip_abort</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">departure_time_is_time_step</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a vehicle (more precisely, platoon)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        W : object</span>
<span class="sd">            The world to which the vehicle belongs.</span>
<span class="sd">        orig : str</span>
<span class="sd">            The origin node.</span>
<span class="sd">        dest : str</span>
<span class="sd">            The destination node.</span>
<span class="sd">        departure_time : int</span>
<span class="sd">            The departure time step of the vehicle.</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            The name of the vehicle, default is the id of the vehicle.</span>
<span class="sd">        route_pref : dict, optional</span>
<span class="sd">            The preference weights for links, default is 0 for all links.</span>
<span class="sd">        route_choice_principle : str, optional</span>
<span class="sd">            The route choice principle of the vehicle, default is the network&#39;s route choice principle.</span>
<span class="sd">        links_prefer : list of str, optional</span>
<span class="sd">            The names of the links the vehicle prefers, default is empty list.</span>
<span class="sd">        links_avoid : list of str, optional</span>
<span class="sd">            The names of the links the vehicle avoids, default is empty list.</span>
<span class="sd">        trip_abort : int, optional</span>
<span class="sd">            Whether to abort the trip if a dead end is reached, default is 1.</span>
<span class="sd">        attribute : any, optinonal</span>
<span class="sd">            Additional (meta) attributes defined by users.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">s</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>
        <span class="c1">#出発・目的地ノード</span>
        <span class="n">s</span><span class="o">.</span><span class="n">orig</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>

        <span class="c1">#出発・到着時刻</span>
        <span class="k">if</span> <span class="n">departure_time_is_time_step</span><span class="p">:</span><span class="c1">#互換性のため，タイムステップ表記</span>
            <span class="n">s</span><span class="o">.</span><span class="n">departure_time</span> <span class="o">=</span> <span class="n">departure_time</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">departure_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">departure_time</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">arrival_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">link_arrival_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">travel_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1">#状態：home, wait, run，end</span>
        <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;home&quot;</span>

        <span class="c1">#リンク内位置</span>
        <span class="n">s</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">s</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">x_next</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">x_old</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#先行・後行車</span>
        <span class="n">s</span><span class="o">.</span><span class="n">leader</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">s</span><span class="o">.</span><span class="n">follower</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#リンク端部の走り残し処理</span>
        <span class="n">s</span><span class="o">.</span><span class="n">move_remain</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#経路選択</span>
        <span class="k">if</span> <span class="n">route_choice_principle</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">route_choice_principle</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">route_choice_principle</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">route_choice_principle</span> <span class="o">=</span> <span class="n">route_choice_principle</span>

        <span class="c1">#希望リンク重み：{link:重み}</span>
        <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span> <span class="o">=</span> <span class="n">route_pref</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="p">:</span><span class="mi">0</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">}</span>

        <span class="c1">#好むリンクと避けるリンク（近視眼的）</span>
        <span class="n">s</span><span class="o">.</span><span class="n">links_prefer</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">links_prefer</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">links_avoid</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">links_avoid</span><span class="p">]</span>

        <span class="c1">#行き止まりに行ってしまったときにトリップを止める</span>
        <span class="n">s</span><span class="o">.</span><span class="n">trip_abort</span> <span class="o">=</span> <span class="n">trip_abort</span>
        <span class="n">s</span><span class="o">.</span><span class="n">flag_trip_aborted</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#ログなど</span>
        <span class="n">s</span><span class="o">.</span><span class="n">log_t</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#時刻</span>
        <span class="n">s</span><span class="o">.</span><span class="n">log_state</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#状態</span>
        <span class="n">s</span><span class="o">.</span><span class="n">log_link</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#リンク</span>
        <span class="n">s</span><span class="o">.</span><span class="n">log_x</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#位置</span>
        <span class="n">s</span><span class="o">.</span><span class="n">log_s</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#車頭距離</span>
        <span class="n">s</span><span class="o">.</span><span class="n">log_v</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#現在速度</span>
        <span class="n">s</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>

        <span class="n">s</span><span class="o">.</span><span class="n">log_t_link</span> <span class="o">=</span> <span class="p">[[</span><span class="n">s</span><span class="o">.</span><span class="n">departure_time</span><span class="p">,</span> <span class="s2">&quot;home&quot;</span><span class="p">]]</span> <span class="c1">#新たなリンクに入った時にその時刻とリンクのみを保存．経路分析用</span>
        <span class="c1">#todo: s.departure_timeがタイムステップ表記の事がある</span>

        <span class="n">s</span><span class="o">.</span><span class="n">attribute</span> <span class="o">=</span> <span class="n">attribute</span>

        <span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_LIVING</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span></div>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Vehicle </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">state</span><span class="si">}</span><span class="s2">, x=</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s2">, link=</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

<div class="viewcode-block" id="Vehicle.update"><a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the vehicle&#39;s state and position.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method updates the state and position of the vehicle based on its current situation.</span>

<span class="sd">        - If the vehicle is at &quot;home&quot;, it checks if the current time matches its departure time. If so, the vehicle&#39;s state is set to &quot;wait&quot; and it is added to the generation queue of its origin node.</span>
<span class="sd">        - If the vehicle is in the &quot;wait&quot; state, it remains waiting at its departure node.</span>
<span class="sd">        - If the vehicle is in the &quot;run&quot; state, it updates its speed and position. If the vehicle reaches the end of its current link, it either ends its trip if it has reached its destination, or requests a transfer to the next link.</span>
<span class="sd">        - If the vehicle&#39;s state is &quot;end&quot; or &quot;abort&quot;, no further actions are taken.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">record_log</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;home&quot;</span><span class="p">:</span>
            <span class="c1">#需要生成</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">departure_time</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;wait&quot;</span>
                <span class="n">s</span><span class="o">.</span><span class="n">orig</span><span class="o">.</span><span class="n">generation_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;wait&quot;</span><span class="p">:</span>
            <span class="c1">#出発ノードで待つ</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;run&quot;</span><span class="p">:</span>
            <span class="c1">#走行</span>
            <span class="n">s</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">x_next</span><span class="o">-</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>
            <span class="n">s</span><span class="o">.</span><span class="n">x_old</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">x</span>
            <span class="n">s</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">x_next</span>

            <span class="c1">#リンク下流端</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">end_node</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="n">dest</span><span class="p">:</span>
                    <span class="c1">#トリップ終了</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">end_trip</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">outlinks</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">trip_abort</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">flag_trip_aborted</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">route_next_link</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">end_trip</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#リンク間遷移リクエスト</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">route_next_link_choice</span><span class="p">()</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">incoming_vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;abort&quot;</span><span class="p">]</span> <span class="p">:</span>
            <span class="c1">#終わり</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="Vehicle.end_trip"><a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.end_trip">[docs]</a>    <span class="k">def</span> <span class="nf">end_trip</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Procedure when the vehicle finishes its trip.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;end&quot;</span>

        <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
        <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">traveltime_actual</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">link_arrival_time</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">):]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">link_arrival_time</span>  <span class="c1">#端部の挙動改善 todo: 精査</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">follower</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">follower</span><span class="o">.</span><span class="n">leader</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">s</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">arrival_time</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span>
        <span class="n">s</span><span class="o">.</span><span class="n">travel_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">arrival_time</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">departure_time</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_RUNNING</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_LIVING</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">flag_trip_aborted</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;abort&quot;</span>
            <span class="n">s</span><span class="o">.</span><span class="n">arrival_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">s</span><span class="o">.</span><span class="n">travel_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">s</span><span class="o">.</span><span class="n">record_log</span><span class="p">()</span></div>

<div class="viewcode-block" id="Vehicle.carfollow"><a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.carfollow">[docs]</a>    <span class="k">def</span> <span class="nf">carfollow</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Drive withing a link.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">x_next</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">leader</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_cong</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">leader</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">delta</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
            <span class="k">if</span> <span class="n">x_cong</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="p">:</span>
                <span class="n">x_cong</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">x</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">x_next</span> <span class="o">&gt;</span> <span class="n">x_cong</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">x_next</span> <span class="o">=</span> <span class="n">x_cong</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">x_next</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">move_remain</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">x_next</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">length</span>
            <span class="n">s</span><span class="o">.</span><span class="n">x_next</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">length</span></div>

<div class="viewcode-block" id="Vehicle.route_pref_update"><a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.route_pref_update">[docs]</a>    <span class="k">def</span> <span class="nf">route_pref_update</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">weight</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the vehicle&#39;s link preferences for route choice.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        weight : float</span>
<span class="sd">            The weight for updating the link preferences based on the recent travel time.</span>
<span class="sd">            Should be in the range [0, 1], where 0 means the old preferences are fully retained and 1 means the preferences are completely updated.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method updates the link preferences used by the vehicle to select its route based on its current understanding of the system.</span>

<span class="sd">        - If the vehicle&#39;s route choice principle is &quot;homogeneous_DUO&quot;, it will update its preferences based on a global, homogenous dynamic user optimization (DUO) model.</span>
<span class="sd">        - If the route choice principle is &quot;heterogeneous_DUO&quot;, it will update its preferences based on a heterogeneous DUO model, considering both its past preferences and the system&#39;s current state.</span>

<span class="sd">        The updated preferences guide the vehicle&#39;s decisions in subsequent route choices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">route_choice_principle</span> <span class="o">==</span> <span class="s2">&quot;homogeneous_DUO&quot;</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">ROUTECHOICE</span><span class="o">.</span><span class="n">route_pref</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">route_choice_principle</span> <span class="o">==</span> <span class="s2">&quot;heterogeneous_DUO&quot;</span><span class="p">:</span>
            <span class="n">route_pref_new</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="p">:</span><span class="mi">0</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">}</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">id</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">id</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">id</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">ROUTECHOICE</span><span class="o">.</span><span class="n">next</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">route_pref_new</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">route_pref</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1">#最初にpreferenceが空なら確定的に初期化</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">weight</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">route_pref</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+</span> <span class="n">weight</span><span class="o">*</span><span class="n">route_pref_new</span><span class="p">[</span><span class="n">l</span><span class="p">]</span></div>

<div class="viewcode-block" id="Vehicle.route_next_link_choice"><a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.route_next_link_choice">[docs]</a>    <span class="k">def</span> <span class="nf">route_next_link_choice</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select a next link from the current link.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">dest</span> <span class="o">!=</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="p">:</span>
            <span class="n">outlinks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">outlinks</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outlinks</span><span class="p">):</span>

                <span class="c1">#好むリンク・避けるリンクがあれば優先する</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">outlinks</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">links_prefer</span><span class="p">):</span>
                    <span class="n">outlinks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">outlinks</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">links_prefer</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">outlinks</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">links_avoid</span><span class="p">):</span>
                    <span class="n">outlinks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">outlinks</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">links_avoid</span><span class="p">))</span>

                <span class="n">preference</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">route_pref</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">outlinks</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">preference</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">route_next_link</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">outlinks</span><span class="p">,</span> <span class="n">preference</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">route_next_link</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">outlinks</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">route_next_link</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Vehicle.traveled_route"><a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.traveled_route">[docs]</a>    <span class="k">def</span> <span class="nf">traveled_route</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the route this vehicle traveled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">link_old</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">t</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">route</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">log_link</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">link_old</span> <span class="o">!=</span> <span class="n">link</span><span class="p">:</span>
                <span class="n">route</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                <span class="n">ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">log_t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">link_old</span> <span class="o">=</span> <span class="n">link</span>

        <span class="k">return</span> <span class="n">Route</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">route</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">ts</span></div>

<div class="viewcode-block" id="Vehicle.record_log"><a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.record_log">[docs]</a>    <span class="k">def</span> <span class="nf">record_log</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Record travel logs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="s2">&quot;run&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">log_t_link</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">log_t_link</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">])</span>

            <span class="n">s</span><span class="o">.</span><span class="n">log_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">log_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">log_link</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">log_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">log_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">log_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;wait&quot;</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">average_speed_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">average_speed</span> <span class="o">+=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">log_link</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">log_link</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">log_t_link</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="p">])</span>

            <span class="n">s</span><span class="o">.</span><span class="n">log_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">log_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">log_link</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">log_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">log_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">leader</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="n">leader</span><span class="o">.</span><span class="n">link</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">log_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">leader</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">log_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">average_speed_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">average_speed</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">v</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">average_speed</span><span class="p">)</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">average_speed_count</span></div></div>

<span class="c1"># 経路選択クラス</span>
<div class="viewcode-block" id="RouteChoice"><a class="viewcode-back" href="../../uxsim.html#uxsim.RouteChoice">[docs]</a><span class="k">class</span> <span class="nc">RouteChoice</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for computing shortest path for all vehicles.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RouteChoice.__init__"><a class="viewcode-back" href="../../_autosummary/uxsim.RouteChoice.html#uxsim.RouteChoice.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">W</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create route choice computation object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        W : object</span>
<span class="sd">            The world to which this belongs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>
        <span class="c1">#リンク旅行時間行列</span>
        <span class="n">s</span><span class="o">.</span><span class="n">adj_mat_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)])</span>
        <span class="c1">#ij間最短距離</span>
        <span class="n">s</span><span class="o">.</span><span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)])</span>
        <span class="c1">#iからjに行くために次に進むべきノード</span>
        <span class="n">s</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)])</span>
        <span class="c1">#iからjに行くために来たノード</span>
        <span class="n">s</span><span class="o">.</span><span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)])</span>

        <span class="c1">#homogeneous DUO用．kに行くための最短経路的上にあれば1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="p">{</span><span class="n">l</span><span class="p">:</span><span class="mi">0</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">}</span></div>

<div class="viewcode-block" id="RouteChoice.route_search_all"><a class="viewcode-back" href="../../uxsim.html#uxsim.RouteChoice.route_search_all">[docs]</a>    <span class="k">def</span> <span class="nf">route_search_all</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">infty</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the current shortest path based on instantanious travel time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        infty : float</span>
<span class="sd">            value representing infinity.</span>
<span class="sd">        noise : float</span>
<span class="sd">            very small noise to slightly randomize route choice. useful to eliminate strange results at an initial stage of simulation where many routes has identical travel time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">id</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">id</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">ADJ_MAT</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">adj_mat_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">noise</span><span class="p">)</span> <span class="o">+</span> <span class="n">link</span><span class="o">.</span><span class="n">route_choice_penalty</span>
                <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">capacity_in</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#流入禁止の場合は通行不可</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">adj_mat_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">adj_mat_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="n">s</span><span class="o">.</span><span class="n">dist</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">pred</span> <span class="o">=</span> <span class="n">floyd_warshall</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">adj_mat_time</span><span class="p">,</span> <span class="n">return_predecessors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">n_vertices</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_vertices</span><span class="p">,</span> <span class="n">n_vertices</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_vertices</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_vertices</span><span class="p">):</span>
                <span class="c1"># iからjへの最短経路を逆にたどる．．． -&gt; todo: 起終点を逆にした最短経路探索にすればよい</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">:</span>
                    <span class="n">prev</span> <span class="o">=</span> <span class="n">j</span>
                    <span class="k">while</span> <span class="n">s</span><span class="o">.</span><span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">prev</span><span class="p">]</span> <span class="o">!=</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">prev</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">9999</span><span class="p">:</span>
                        <span class="n">prev</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">prev</span><span class="p">]</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">next</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev</span></div>

<div class="viewcode-block" id="RouteChoice.route_search_all_old"><a class="viewcode-back" href="../../uxsim.html#uxsim.RouteChoice.route_search_all_old">[docs]</a>    <span class="k">def</span> <span class="nf">route_search_all_old</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">infty</span><span class="o">=</span><span class="mi">9999999999999999999</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the current shortest path based on instantanious travel time. Old version, slow for large networks.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        infty : float</span>
<span class="sd">            value representing infinity.</span>
<span class="sd">        noise : float</span>
<span class="sd">            very small noise to slightly randomize route choice. useful to eliminate strange results at an initial stage of simulation where many routes has identical travel time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">id</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">id</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">ADJ_MAT</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">adj_mat_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">noise</span><span class="p">)</span> <span class="o">+</span> <span class="n">link</span><span class="o">.</span><span class="n">route_choice_penalty</span>
                <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">capacity_in</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#流入禁止の場合は通行不可</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">adj_mat_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">adj_mat_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)])</span>
        <span class="nb">next</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">adj_mat_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">adj_mat_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="nb">next</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                    <span class="nb">next</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">infty</span>
                    <span class="nb">next</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">dist</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">]:</span>
                        <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">dist</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                        <span class="nb">next</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span>
        <span class="n">s</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">next</span></div>

<div class="viewcode-block" id="RouteChoice.homogeneous_DUO_update"><a class="viewcode-back" href="../../uxsim.html#uxsim.RouteChoice.homogeneous_DUO_update">[docs]</a>    <span class="k">def</span> <span class="nf">homogeneous_DUO_update</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update link preference of all homogeneous travelers based on DUO principle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dest</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="n">id</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DUO_UPDATE_WEIGHT</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">route_pref</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1">#最初にpreferenceが空なら確定的に初期化</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">id</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">id</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">ROUTECHOICE</span><span class="o">.</span><span class="n">next</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">weight</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">route_pref</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">+</span> <span class="n">weight</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">weight</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">route_pref</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]</span></div></div>

<span class="c1"># 結果分析クラス</span>
<div class="viewcode-block" id="Analyzer"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer">[docs]</a><span class="k">class</span> <span class="nc">Analyzer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for analyzing and visualizing a simulation result.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Analyzer.__init__"><a class="viewcode-back" href="../../_autosummary/uxsim.Analyzer.html#uxsim.Analyzer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">W</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create result analysis object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        W : object</span>
<span class="sd">            The world to which this belongs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1">#基礎統計量</span>
        <span class="n">s</span><span class="o">.</span><span class="n">average_speed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">average_speed_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">trip_completed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">trip_all</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">total_travel_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">average_travel_time</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#フラグ</span>
        <span class="n">s</span><span class="o">.</span><span class="n">flag_edie_state_computed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">flag_trajectory_computed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">flag_pandas_convert</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">flag_od_analysis</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Analyzer.basic_analysis"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.basic_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">basic_analysis</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze basic stats.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">od_to_pandas</span><span class="p">()</span>

        <span class="n">s</span><span class="o">.</span><span class="n">trip_completed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;completed_trips&quot;</span><span class="p">])</span>
        <span class="n">s</span><span class="o">.</span><span class="n">trip_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_trips&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">trip_completed</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">total_travel_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;completed_trips&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;average_travel_time&quot;</span><span class="p">])</span>
            <span class="n">s</span><span class="o">.</span><span class="n">average_travel_time</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">total_travel_time</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">trip_completed</span>
            <span class="n">s</span><span class="o">.</span><span class="n">total_delay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;completed_trips&quot;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;average_travel_time&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;free_travel_time&quot;</span><span class="p">]))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">average_delay</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">total_delay</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">trip_completed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">total_travel_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">s</span><span class="o">.</span><span class="n">average_travel_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">s</span><span class="o">.</span><span class="n">total_delay</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">s</span><span class="o">.</span><span class="n">average_delay</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span></div>


<div class="viewcode-block" id="Analyzer.od_analysis"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.od_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">od_analysis</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze OD-specific stats: number of trips, number of completed trips, free-flow travel time, average travel time, its std</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">flag_od_analysis</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">flag_od_analysis</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">s</span><span class="o">.</span><span class="n">od_trips</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">od_trips_comp</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">od_tt_free</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">od_tt</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[])</span>
        <span class="n">s</span><span class="o">.</span><span class="n">od_tt_ave</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">od_tt_std</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">dn</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>

        <span class="c1">#自由旅行時間</span>
        <span class="n">adj_mat_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">id</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">id</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">ADJ_MAT</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">adj_mat_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="n">link</span><span class="o">.</span><span class="n">u</span>
                <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">capacity_in</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#流入禁止の場合は通行不可</span>
                    <span class="n">adj_mat_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">adj_mat_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">floyd_warshall</span><span class="p">(</span><span class="n">adj_mat_time</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">orig</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">dest</span>
            <span class="n">s</span><span class="o">.</span><span class="n">od_trips</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">d</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dn</span>
            <span class="k">if</span> <span class="n">veh</span><span class="o">.</span><span class="n">travel_time</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">od_trips_comp</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">d</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dn</span>
                <span class="n">s</span><span class="o">.</span><span class="n">od_tt</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">travel_time</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">o</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">od_tt</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">s</span><span class="o">.</span><span class="n">od_tt_ave</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">od_tt</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">d</span><span class="p">])</span>
            <span class="n">s</span><span class="o">.</span><span class="n">od_tt_std</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">od_tt</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">d</span><span class="p">])</span>
            <span class="n">s</span><span class="o">.</span><span class="n">od_tt_free</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">id</span><span class="p">]</span></div>

<div class="viewcode-block" id="Analyzer.link_analysis_coarse"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.link_analysis_coarse">[docs]</a>    <span class="k">def</span> <span class="nf">link_analysis_coarse</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze link-level coarse stats: traffic volume, remaining vehicles, free-flow travel time, average travel time, its std.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">linkc_volume</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">linkc_tt_free</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">linkc_tt_ave</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">linkc_tt_std</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">linkc_remain</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">linkc_volume</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">s</span><span class="o">.</span><span class="n">linkc_remain</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">l</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">s</span><span class="o">.</span><span class="n">linkc_tt_free</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">u</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">linkc_volume</span><span class="p">[</span><span class="n">l</span><span class="p">]:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">linkc_tt_ave</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">traveltime_actual</span> <span class="k">if</span> <span class="n">t</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">s</span><span class="o">.</span><span class="n">linkc_tt_std</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">traveltime_actual</span> <span class="k">if</span> <span class="n">t</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="Analyzer.compute_accurate_traj"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.compute_accurate_traj">[docs]</a>    <span class="k">def</span> <span class="nf">compute_accurate_traj</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate more complete vehicle trajectories for each link by extrapolating recorded trajectories. It is assumed that vehicles are in free-flow travel at the end of the link.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">flag_trajectory_computed</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">flag_trajectory_computed</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">l_old</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lange</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">log_t</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">veh</span><span class="o">.</span><span class="n">log_link</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">log_link</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">l_old</span> <span class="o">!=</span> <span class="n">l</span><span class="p">:</span>
                        <span class="n">l</span><span class="o">.</span><span class="n">tss</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="n">l</span><span class="o">.</span><span class="n">xss</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="n">l</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">color</span><span class="p">)</span>
                        <span class="n">l</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                    <span class="n">l_old</span> <span class="o">=</span> <span class="n">l</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">tss</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">log_t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">xss</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">log_x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
            <span class="c1">#端部を外挿</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lange</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">xss</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">xss</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">xss</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">x_remain</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">xss</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">x_remain</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">u</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="o">*</span><span class="mf">0.01</span><span class="p">:</span>
                            <span class="n">l</span><span class="o">.</span><span class="n">xss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">l</span><span class="o">.</span><span class="n">tss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">tss</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x_remain</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">u</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">length</span><span class="o">-</span><span class="n">l</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span> <span class="o">&lt;=</span> <span class="n">l</span><span class="o">.</span><span class="n">xss</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">l</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
                        <span class="n">x_remain</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">length</span><span class="o">-</span><span class="n">l</span><span class="o">.</span><span class="n">xss</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">x_remain</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">u</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="o">*</span><span class="mf">0.01</span><span class="p">:</span>
                            <span class="n">l</span><span class="o">.</span><span class="n">xss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
                            <span class="n">l</span><span class="o">.</span><span class="n">tss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">tss</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">x_remain</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">u</span><span class="p">)</span></div>

<div class="viewcode-block" id="Analyzer.compute_edie_state"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.compute_edie_state">[docs]</a>    <span class="k">def</span> <span class="nf">compute_edie_state</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Edie&#39;s traffic state for each link.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">flag_edie_state_computed</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">flag_edie_state_computed</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">s</span><span class="o">.</span><span class="n">compute_accurate_traj</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
            <span class="n">DELTAX</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">edie_dx</span>
            <span class="n">DELTATE</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">edie_dt</span>
            <span class="n">MAXX</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">length</span>
            <span class="n">MAXT</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span>

            <span class="n">dt</span> <span class="o">=</span> <span class="n">DELTATE</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">DELTAX</span>
            <span class="n">tn</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">MAXX</span><span class="o">/</span><span class="n">DELTAX</span><span class="p">))]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">MAXT</span><span class="o">/</span><span class="n">DELTATE</span><span class="p">))]</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">MAXX</span><span class="o">/</span><span class="n">DELTAX</span><span class="p">))]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">MAXT</span><span class="o">/</span><span class="n">DELTATE</span><span class="p">))]</span>

            <span class="n">l</span><span class="o">.</span><span class="n">k_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">MAXT</span><span class="o">/</span><span class="n">DELTATE</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">MAXX</span><span class="o">/</span><span class="n">DELTAX</span><span class="p">)])</span>
            <span class="n">l</span><span class="o">.</span><span class="n">q_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">MAXT</span><span class="o">/</span><span class="n">DELTATE</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">MAXX</span><span class="o">/</span><span class="n">DELTAX</span><span class="p">)])</span>
            <span class="n">l</span><span class="o">.</span><span class="n">v_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">MAXT</span><span class="o">/</span><span class="n">DELTATE</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">MAXX</span><span class="o">/</span><span class="n">DELTAX</span><span class="p">)])</span>

            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">lange</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">xss</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lange</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">xss</span><span class="p">[</span><span class="n">v</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">i0</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                    <span class="n">x0</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">xss</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">x1</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">xss</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">t0</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">tss</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">t1</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">tss</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">t1</span><span class="o">-</span><span class="n">t0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">v0</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">#compute_accurate_traj()の外挿で極稀にt1=t0になったのでエラー回避（もう起きないはずだが念のため）</span>
                        <span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="n">tt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t0</span><span class="o">//</span><span class="n">dt</span><span class="p">)</span>
                    <span class="n">xx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x0</span><span class="o">//</span><span class="n">dx</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">v0</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1">#残り</span>
                        <span class="n">xl0</span> <span class="o">=</span> <span class="n">dx</span><span class="o">-</span><span class="n">x0</span><span class="o">%</span><span class="n">dx</span>
                        <span class="n">xl1</span> <span class="o">=</span> <span class="n">x1</span><span class="o">%</span><span class="n">dx</span>
                        <span class="n">tl0</span> <span class="o">=</span> <span class="n">xl0</span><span class="o">/</span><span class="n">v0</span>
                        <span class="n">tl1</span> <span class="o">=</span> <span class="n">xl1</span><span class="o">/</span><span class="n">v0</span>

                        <span class="k">if</span> <span class="n">tt</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">MAXT</span><span class="o">/</span><span class="n">DELTATE</span><span class="p">)</span> <span class="ow">and</span> <span class="n">xx</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">MAXX</span><span class="o">/</span><span class="n">DELTAX</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">xx</span> <span class="o">==</span> <span class="n">x1</span><span class="o">//</span><span class="n">dx</span><span class="p">:</span>
                                <span class="c1">#(x,t)</span>
                                <span class="n">dn</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="n">xx</span><span class="p">][</span><span class="n">i0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">x1</span><span class="o">-</span><span class="n">x0</span>
                                <span class="n">tn</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="n">xx</span><span class="p">][</span><span class="n">i0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">t1</span><span class="o">-</span><span class="n">t0</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1">#(x+n, t)</span>
                                <span class="n">jj</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x1</span><span class="o">//</span><span class="n">dx</span><span class="o">-</span><span class="n">xx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jj</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">xx</span><span class="o">+</span><span class="n">j</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">MAXX</span><span class="o">/</span><span class="n">DELTAX</span><span class="p">):</span>
                                        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="n">dn</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="n">xx</span><span class="o">+</span><span class="n">j</span><span class="p">][</span><span class="n">i0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">xl0</span>
                                            <span class="n">tn</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="n">xx</span><span class="o">+</span><span class="n">j</span><span class="p">][</span><span class="n">i0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tl0</span>
                                        <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span> <span class="n">jj</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                            <span class="n">dn</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="n">xx</span><span class="o">+</span><span class="n">j</span><span class="p">][</span><span class="n">i0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">xl1</span>
                                            <span class="n">tn</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="n">xx</span><span class="o">+</span><span class="n">j</span><span class="p">][</span><span class="n">i0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tl1</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">dn</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="n">xx</span><span class="o">+</span><span class="n">j</span><span class="p">][</span><span class="n">i0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span>
                                            <span class="n">tn</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="n">xx</span><span class="o">+</span><span class="n">j</span><span class="p">][</span><span class="n">i0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span><span class="o">/</span><span class="n">v0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">tt</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">MAXT</span><span class="o">/</span><span class="n">DELTATE</span><span class="p">)</span> <span class="ow">and</span> <span class="n">xx</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">MAXX</span><span class="o">/</span><span class="n">DELTAX</span><span class="p">):</span>
                            <span class="n">dn</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="n">xx</span><span class="p">][</span><span class="n">i0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">0</span>
                            <span class="n">tn</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="n">xx</span><span class="p">][</span><span class="n">i0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">t1</span><span class="o">-</span><span class="n">t0</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lange</span><span class="p">(</span><span class="n">tn</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">lange</span><span class="p">(</span><span class="n">tn</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">tn_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">dn_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">k_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">tn_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">DELTATE</span><span class="o">/</span><span class="n">DELTAX</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">q_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">dn_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">DELTATE</span><span class="o">/</span><span class="n">DELTAX</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
                <span class="n">l</span><span class="o">.</span><span class="n">v_mat</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">q_mat</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">k_mat</span>
            <span class="n">l</span><span class="o">.</span><span class="n">v_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">v_mat</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">u</span><span class="p">)</span></div>

<div class="viewcode-block" id="Analyzer.print_simple_stats"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.print_simple_stats">[docs]</a>    <span class="nd">@catch_exceptions_and_warn</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">print_simple_stats</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">force_print</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints basic statistics of simulation result.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        force_print : bool, optional</span>
<span class="sd">            print the stats regardless of the value of `print_mode`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;results:&quot;</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; average speed:</span><span class="se">\t</span><span class="s2"> </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">average_speed</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> m/s&quot;</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; number of completed trips:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">trip_completed</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">trip_completed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; average travel time of trips:</span><span class="se">\t</span><span class="s2"> </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">average_travel_time</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; average delay of trips:</span><span class="se">\t</span><span class="s2"> </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">average_delay</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; delay ratio:</span><span class="se">\t\t\t</span><span class="s2"> </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">average_delay</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">average_travel_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">force_print</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">print_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;results:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; average speed:</span><span class="se">\t</span><span class="s2"> </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">average_speed</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> m/s&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; number of completed trips:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">trip_completed</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">trip_completed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; average travel time of trips:</span><span class="se">\t</span><span class="s2"> </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">average_travel_time</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; average delay of trips:</span><span class="se">\t</span><span class="s2"> </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">average_delay</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; delay ratio:</span><span class="se">\t\t\t</span><span class="s2"> </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">average_delay</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">average_travel_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">comp_route_travel_time</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">route</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="Analyzer.time_space_diagram_traj"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.time_space_diagram_traj">[docs]</a>    <span class="nd">@catch_exceptions_and_warn</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">time_space_diagram_traj</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">plot_signal</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draws the time-space diagram of vehicle trajectories for vehicles on specified links.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        links : list of link or link, optional</span>
<span class="sd">            The names of the links for which the time-space diagram is to be plotted.</span>
<span class="sd">            If None, the diagram is plotted for all links in the network. Default is None.</span>
<span class="sd">        figsize : tuple of int, optional</span>
<span class="sd">            The size of the figure to be plotted, default is (12,4).</span>
<span class="sd">        plot_signal : bool, optional</span>
<span class="sd">            Plot the downstream signal red light.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#リンク車両軌跡の時空間図</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; drawing trajectories...&quot;</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">compute_accurate_traj</span><span class="p">()</span>

        <span class="c1">#対象がlistであればOKで，単一な場合にはlistに変換する．未指定であれば全部にする．</span>
        <span class="k">if</span> <span class="n">links</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">links</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">iter</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">links</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">links</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">links</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">lll</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">print_mode</span><span class="o">==</span><span class="mi">0</span><span class="p">)):</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">lll</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">xss</span><span class="p">)):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">tss</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">l</span><span class="o">.</span><span class="n">xss</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plot_signal</span><span class="p">:</span>
                <span class="n">signal_log</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lange</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">signal_log</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">signal_log</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">signal_group</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">signal</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">signal_log</span><span class="p">,</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">length</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lange</span><span class="p">(</span><span class="n">signal_log</span><span class="p">)],</span> <span class="s2">&quot;r.&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time (s)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;space (m)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">length</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">save_mode</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/tsd_traj_</span><span class="si">{</span><span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">show_mode</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Analyzer.time_space_diagram_density"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.time_space_diagram_density">[docs]</a>    <span class="nd">@catch_exceptions_and_warn</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">time_space_diagram_density</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">plot_signal</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draws the time-space diagram of traffic density on specified links.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        links : list of link or link, optional</span>
<span class="sd">            The names of the links for which the time-space diagram is to be plotted.</span>
<span class="sd">            If None, the diagram is plotted for all links in the network. Default is None.</span>
<span class="sd">        figsize : tuple of int, optional</span>
<span class="sd">            The size of the figure to be plotted, default is (12,4).</span>
<span class="sd">        plot_signal : bool, optional</span>
<span class="sd">            Plot the downstream signal red light.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#リンク密度の時空間図</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; drawing traffic states...&quot;</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">compute_edie_state</span><span class="p">()</span>

        <span class="c1">#対象がlistであればOKで，単一な場合にはlistに変換する．未指定であれば全部にする．</span>
        <span class="k">if</span> <span class="n">links</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">links</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">iter</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">links</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">links</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">links</span><span class="p">]</span>

        <span class="n">s</span><span class="o">.</span><span class="n">compute_edie_state</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">lll</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">print_mode</span><span class="o">==</span><span class="mi">0</span><span class="p">)):</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">lll</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">k_mat</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">edie_dt</span><span class="p">)</span><span class="o">*</span><span class="n">l</span><span class="o">.</span><span class="n">edie_dt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">edie_dx</span><span class="p">)</span><span class="o">*</span><span class="n">l</span><span class="o">.</span><span class="n">edie_dx</span><span class="p">),</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;inferno&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plot_signal</span><span class="p">:</span>
                <span class="n">signal_log</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lange</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">signal_log</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">signal_log</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">signal_group</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">signal</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">signal_log</span><span class="p">,</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">length</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lange</span><span class="p">(</span><span class="n">signal_log</span><span class="p">)],</span> <span class="s2">&quot;r.&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;density (veh/m)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time (s)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;space (m)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">length</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">save_mode</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/tsd_k_</span><span class="si">{</span><span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">show_mode</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Analyzer.time_space_diagram_traj_links"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.time_space_diagram_traj_links">[docs]</a>    <span class="nd">@catch_exceptions_and_warn</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">time_space_diagram_traj_links</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">linkslist</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">plot_signal</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draws the time-space diagram of vehicle trajectories for vehicles on concective links.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        linkslist : list of link or list of list of link</span>
<span class="sd">            The names of the concective links for which the time-space diagram is to be plotted.</span>
<span class="sd">        figsize : tuple of int, optional</span>
<span class="sd">            The size of the figure to be plotted, default is (12,4).</span>
<span class="sd">        plot_signal : bool, optional</span>
<span class="sd">            Plot the signal red light.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#複数リンクの連続した車両軌跡の時空間図</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; drawing trajectories in consecutive links...&quot;</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">compute_accurate_traj</span><span class="p">()</span>

        <span class="c1">#リンクリストのリストであればそのまま，そうでなければリスト化</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">iter</span><span class="p">(</span><span class="n">linkslist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">linkslist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">linkslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">linkslist</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">linkslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">linkslist</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">links</span> <span class="ow">in</span> <span class="n">linkslist</span><span class="p">:</span>
            <span class="n">linkdict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
                <span class="n">linkdict</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
                <span class="n">d</span> <span class="o">+=</span> <span class="n">l</span><span class="o">.</span><span class="n">length</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">xss</span><span class="p">)):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">tss</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">xss</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="n">linkdict</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">plot_signal</span><span class="p">:</span>
                    <span class="n">signal_log</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lange</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">signal_log</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">signal_log</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">signal_group</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">signal</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)]</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">signal_log</span><span class="p">,</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">length</span><span class="o">+</span><span class="n">linkdict</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lange</span><span class="p">(</span><span class="n">signal_log</span><span class="p">)],</span> <span class="s2">&quot;r.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">linkdict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="p">],</span> <span class="p">[</span><span class="n">linkdict</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">linkdict</span><span class="p">[</span><span class="n">l</span><span class="p">]],</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="p">],</span> <span class="p">[</span><span class="n">linkdict</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">l</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">linkdict</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">l</span><span class="o">.</span><span class="n">length</span><span class="p">],</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linkdict</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">l</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linkdict</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">l</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linkdict</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">+</span><span class="n">l</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time (s)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;space (m)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">save_mode</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/tsd_traj_links_</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">links</span><span class="p">])</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">show_mode</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Analyzer.cumulative_curves"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.cumulative_curves">[docs]</a>    <span class="nd">@catch_exceptions_and_warn</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">cumulative_curves</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the cumulative curves and travel times for the provided links.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        links : list or object, optional</span>
<span class="sd">            A list of links or a single link for which the cumulative curves and travel times are to be plotted.</span>
<span class="sd">            If not provided, the cumulative curves and travel times for all the links in the network will be plotted.</span>
<span class="sd">        figsize : tuple of int, optional</span>
<span class="sd">            The size of the figure to be plotted. Default is (6, 4).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method plots the cumulative curves for vehicle arrivals and departures, as well as the instantaneous and actual travel times.</span>
<span class="sd">        The plots are saved to the directory `out&lt;W.name&gt;` with the filename format `cumulative_curves_&lt;link.name&gt;.png`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#対象がlistであればOKで，単一な場合にはlistに変換する．未指定であれば全部にする．</span>
        <span class="k">if</span> <span class="n">links</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">links</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">iter</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">links</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">flag_single</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">links</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">),</span> <span class="n">link</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">,</span> <span class="s2">&quot;r-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;arrival&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">),</span> <span class="n">link</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">,</span> <span class="s2">&quot;b-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;departure&quot;</span><span class="p">)</span>

            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">),</span> <span class="n">link</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;instantaneous&quot;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">),</span> <span class="n">link</span><span class="o">.</span><span class="n">traveltime_actual</span><span class="p">,</span> <span class="s2">&quot;k.&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;actual&quot;</span><span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time(s)&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;cumlative count (veh)&quot;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;travel time (s)&quot;</span><span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">save_mode</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/cumlative_curves_</span><span class="si">{</span><span class="n">link</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">show_mode</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Analyzer.network"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.network">[docs]</a>    <span class="nd">@catch_exceptions_and_warn</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">network</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detailed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">minwidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">maxwidth</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">left_handed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tmp_anim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">network_font_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualizes the entire transportation network and its current traffic conditions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t : float, optional</span>
<span class="sd">            The current time for which the traffic conditions are visualized.</span>
<span class="sd">        detailed : int, optional</span>
<span class="sd">            Determines the level of detail in the visualization.</span>
<span class="sd">            If set to 1, the link internals (cell) are displayed in detail.</span>
<span class="sd">            If set to 0, the visualization is simplified to link-level. Default is 1.</span>
<span class="sd">        minwidth : float, optional</span>
<span class="sd">            The minimum width of the link visualization. Default is 0.5.</span>
<span class="sd">        maxwidth : float, optional</span>
<span class="sd">            The maximum width of the link visualization. Default is 12.</span>
<span class="sd">        left_handed : int, optional</span>
<span class="sd">            If set to 1, the left-handed traffic system (e.g., Japan, UK) is used. If set to 0, the right-handed one is used. Default is 1.</span>
<span class="sd">        tmp_anim : int, optional</span>
<span class="sd">            If set to 1, the visualization will be saved as a temporary animation frame. Default is 0.</span>
<span class="sd">        figsize : tuple of int, optional</span>
<span class="sd">            The size of the figure to be plotted. Default is (6, 6).</span>
<span class="sd">        network_font_size : int, optional</span>
<span class="sd">            The font size for the network labels. Default is 4.</span>
<span class="sd">        node_size : int, optional</span>
<span class="sd">            The size of the nodes in the visualization. Default is 2.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method visualizes the entire transportation network and its current traffic conditions.</span>
<span class="sd">        The visualization provides information on vehicle density, velocity, link names, node locations, and more.</span>
<span class="sd">        The plots are saved to the directory `out&lt;W.name&gt;` with filenames depending on the `detailed` and `t` parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">compute_edie_state</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t = </span><span class="si">{</span><span class="n">t</span><span class="w"> </span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> (s)&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s2">&quot;ko&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">node_size</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">network_font_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">network_font_size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">y</span>
            <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">y</span>
            <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">y2</span><span class="p">)</span><span class="o">*</span><span class="mf">0.05</span><span class="p">,</span> <span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.05</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">left_handed</span><span class="p">:</span>
                <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span> <span class="o">=</span> <span class="o">-</span><span class="n">vx</span><span class="p">,</span> <span class="o">-</span><span class="n">vy</span>
            <span class="k">if</span> <span class="n">detailed</span><span class="p">:</span>
                <span class="c1">#詳細モード</span>
                <span class="n">xsize</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">k_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
                <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;k&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xsize</span><span class="p">)]</span>
                <span class="n">lw</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xsize</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xsize</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">k_mat</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">edie_dt</span><span class="p">),</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">v_mat</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">edie_dt</span><span class="p">),</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid time </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> is specified for network visualization&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">lw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">l</span><span class="o">.</span><span class="n">delta</span><span class="o">*</span><span class="p">(</span><span class="n">maxwidth</span><span class="o">-</span><span class="n">minwidth</span><span class="p">)</span><span class="o">+</span><span class="n">minwidth</span>
                    <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s2">&quot;viridis&quot;</span><span class="p">](</span><span class="n">v</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">u</span><span class="p">)</span>
                <span class="n">xmid</span> <span class="o">=</span> <span class="p">[((</span><span class="n">xsize</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">x1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">xsize</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">vx</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xsize</span><span class="p">)]</span>
                <span class="n">ymid</span> <span class="o">=</span> <span class="p">[((</span><span class="n">xsize</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">y1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">xsize</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">vy</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xsize</span><span class="p">)]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x1</span><span class="p">]</span><span class="o">+</span><span class="n">xmid</span><span class="o">+</span><span class="p">[</span><span class="n">x2</span><span class="p">],</span> <span class="p">[</span><span class="n">y1</span><span class="p">]</span><span class="o">+</span><span class="n">ymid</span><span class="o">+</span><span class="p">[</span><span class="n">y2</span><span class="p">],</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xsize</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xmid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmid</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">ymid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ymid</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">network_font_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xmid</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xmid</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)],</span> <span class="n">ymid</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xmid</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)],</span> <span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">network_font_size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#簡略モード</span>
                <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)]</span><span class="o">-</span><span class="n">l</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)])</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">length</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)]</span>
                <span class="n">width</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">l</span><span class="o">.</span><span class="n">delta</span><span class="o">*</span><span class="p">(</span><span class="n">maxwidth</span><span class="o">-</span><span class="n">minwidth</span><span class="p">)</span><span class="o">+</span><span class="n">minwidth</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s2">&quot;viridis&quot;</span><span class="p">](</span><span class="n">v</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">u</span><span class="p">)</span>
                <span class="n">xmid1</span><span class="p">,</span> <span class="n">ymid1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x1</span><span class="o">+</span><span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vx</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">y1</span><span class="o">+</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vy</span>
                <span class="n">xmid2</span><span class="p">,</span> <span class="n">ymid2</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vx</span><span class="p">,</span> <span class="p">(</span><span class="n">y1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vy</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">xmid1</span><span class="p">,</span> <span class="n">xmid2</span><span class="p">,</span> <span class="n">x2</span><span class="p">],</span> <span class="p">[</span><span class="n">y1</span><span class="p">,</span> <span class="n">ymid1</span><span class="p">,</span> <span class="n">ymid2</span><span class="p">,</span> <span class="n">y2</span><span class="p">],</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">xmid1</span><span class="p">,</span> <span class="n">xmid2</span><span class="p">,</span> <span class="n">x2</span><span class="p">],</span> <span class="p">[</span><span class="n">y1</span><span class="p">,</span> <span class="n">ymid1</span><span class="p">,</span> <span class="n">ymid2</span><span class="p">,</span> <span class="n">y2</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">solid_capstyle</span><span class="o">=</span><span class="s2">&quot;butt&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">network_font_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xmid1</span><span class="p">,</span> <span class="n">ymid1</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">network_font_size</span><span class="p">)</span>
        <span class="n">maxx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">minx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">maxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">miny</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">buffx</span><span class="p">,</span> <span class="n">buffy</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxx</span><span class="o">-</span><span class="n">minx</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="n">maxy</span><span class="o">-</span><span class="n">miny</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span>
        <span class="k">if</span> <span class="n">buffx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">buffx</span> <span class="o">=</span> <span class="n">buffy</span>
        <span class="k">if</span> <span class="n">buffy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">buffy</span> <span class="o">=</span> <span class="n">buffx</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">minx</span><span class="o">-</span><span class="n">buffx</span><span class="p">,</span> <span class="n">maxx</span><span class="o">+</span><span class="n">buffx</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">miny</span><span class="o">-</span><span class="n">buffy</span><span class="p">,</span> <span class="n">maxy</span><span class="o">+</span><span class="n">buffy</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tmp_anim</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/tmp_anim_</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">save_mode</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/network</span><span class="si">{</span><span class="n">detailed</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">show_mode</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Analyzer.network_pillow"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.network_pillow">[docs]</a>    <span class="nd">@catch_exceptions_and_warn</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">network_pillow</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detailed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">minwidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">maxwidth</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">left_handed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tmp_anim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">network_font_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">image_return</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualizes the entire transportation network and its current traffic conditions. Faster implementation using Pillow.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t : float, optional</span>
<span class="sd">            The current time for which the traffic conditions are visualized.</span>
<span class="sd">        detailed : int, optional</span>
<span class="sd">            Determines the level of detail in the visualization.</span>
<span class="sd">            If set to 1, the link internals (cell) are displayed in detail.</span>
<span class="sd">            If set to 0, the visualization is simplified to link-level. Default is 1.</span>
<span class="sd">        minwidth : float, optional</span>
<span class="sd">            The minimum width of the link visualization. Default is 0.5.</span>
<span class="sd">        maxwidth : float, optional</span>
<span class="sd">            The maximum width of the link visualization. Default is 12.</span>
<span class="sd">        left_handed : int, optional</span>
<span class="sd">            If set to 1, the left-handed traffic system (e.g., Japan, UK) is used. If set to 0, the right-handed one is used. Default is 1.</span>
<span class="sd">        tmp_anim : int, optional</span>
<span class="sd">            If set to 1, the visualization will be saved as a temporary animation frame. Default is 0.</span>
<span class="sd">        figsize : tuple of int, optional</span>
<span class="sd">            The size of the figure to be plotted. Default is (6, 6).</span>
<span class="sd">        network_font_size : int, optional</span>
<span class="sd">            The font size for the network labels. Default is 4.</span>
<span class="sd">        node_size : int, optional</span>
<span class="sd">            The size of the nodes in the visualization. Default is 2.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method visualizes the entire transportation network and its current traffic conditions.</span>
<span class="sd">        The visualization provides information on vehicle density, velocity, link names, node locations, and more.</span>
<span class="sd">        The plots are saved to the directory `out&lt;W.name&gt;` with filenames depending on the `detailed` and `t` parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">maxx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">minx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">maxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">miny</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="n">figsize</span><span class="o">*</span><span class="mi">100</span><span class="o">*</span><span class="n">scale</span><span class="o">/</span><span class="p">(</span><span class="n">maxx</span><span class="o">-</span><span class="n">minx</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="o">*</span><span class="n">scale</span><span class="o">/</span><span class="p">(</span><span class="n">maxx</span><span class="o">-</span><span class="n">minx</span><span class="p">)</span>
        <span class="n">maxx</span> <span class="o">*=</span> <span class="n">coef</span>
        <span class="n">minx</span> <span class="o">*=</span> <span class="n">coef</span>
        <span class="n">maxy</span> <span class="o">*=</span> <span class="n">coef</span>
        <span class="n">miny</span> <span class="o">*=</span> <span class="n">coef</span>
        <span class="n">minwidth</span> <span class="o">*=</span> <span class="n">scale</span>
        <span class="n">maxwidth</span> <span class="o">*=</span> <span class="n">scale</span>

        <span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxx</span><span class="o">-</span><span class="n">minx</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span>
        <span class="n">maxx</span> <span class="o">+=</span> <span class="n">buffer</span>
        <span class="n">minx</span> <span class="o">-=</span> <span class="n">buffer</span>
        <span class="n">maxy</span> <span class="o">+=</span> <span class="n">buffer</span>
        <span class="n">miny</span> <span class="o">-=</span> <span class="n">buffer</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;RGBA&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">maxx</span><span class="o">-</span><span class="n">minx</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxy</span><span class="o">-</span><span class="n">miny</span><span class="p">)),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
        <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">font_fname</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;uxsim&#39;</span><span class="p">,</span> <span class="s1">&#39;utils/Inconsolata.otf&#39;</span><span class="p">)</span>
        <span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="n">font_fname</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">network_font_size</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">flip</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">coef</span><span class="o">-</span><span class="n">minx</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">coef</span><span class="o">-</span><span class="n">miny</span>
            <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">coef</span><span class="o">-</span><span class="n">minx</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">coef</span><span class="o">-</span><span class="n">miny</span>
            <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">y2</span><span class="p">)</span><span class="o">*</span><span class="mf">0.05</span><span class="p">,</span> <span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.05</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">left_handed</span><span class="p">:</span>
                <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span> <span class="o">=</span> <span class="o">-</span><span class="n">vx</span><span class="p">,</span> <span class="o">-</span><span class="n">vy</span>
            <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)]</span><span class="o">-</span><span class="n">l</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)])</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">length</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)]</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">l</span><span class="o">.</span><span class="n">delta</span><span class="o">*</span><span class="p">(</span><span class="n">maxwidth</span><span class="o">-</span><span class="n">minwidth</span><span class="p">)</span><span class="o">+</span><span class="n">minwidth</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s2">&quot;viridis&quot;</span><span class="p">](</span><span class="n">v</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">u</span><span class="p">)</span>
            <span class="n">xmid1</span><span class="p">,</span> <span class="n">ymid1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x1</span><span class="o">+</span><span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vx</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">y1</span><span class="o">+</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vy</span>
            <span class="n">xmid2</span><span class="p">,</span> <span class="n">ymid2</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vx</span><span class="p">,</span> <span class="p">(</span><span class="n">y1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vy</span>
            <span class="n">draw</span><span class="o">.</span><span class="n">line</span><span class="p">([(</span><span class="n">x1</span><span class="p">,</span> <span class="n">flip</span><span class="p">(</span><span class="n">y1</span><span class="p">)),</span> <span class="p">(</span><span class="n">xmid1</span><span class="p">,</span> <span class="n">flip</span><span class="p">(</span><span class="n">ymid1</span><span class="p">)),</span> <span class="p">(</span><span class="n">xmid2</span><span class="p">,</span> <span class="n">flip</span><span class="p">(</span><span class="n">ymid2</span><span class="p">)),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">flip</span><span class="p">(</span><span class="n">y2</span><span class="p">))],</span> <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">255</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">255</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">255</span><span class="p">)),</span> <span class="n">width</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span><span class="p">),</span> <span class="n">joint</span><span class="o">=</span><span class="s2">&quot;curve&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">network_font_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">xmid1</span><span class="p">,</span> <span class="n">flip</span><span class="p">(</span><span class="n">ymid1</span><span class="p">)),</span> <span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;mm&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">network_font_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">(((</span><span class="n">n</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">coef</span><span class="o">-</span><span class="n">minx</span><span class="p">,</span> <span class="n">flip</span><span class="p">((</span><span class="n">n</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">coef</span><span class="o">-</span><span class="n">miny</span><span class="p">)),</span> <span class="n">n</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;mm&quot;</span><span class="p">)</span>
                <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">(((</span><span class="n">n</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">coef</span><span class="o">-</span><span class="n">minx</span><span class="p">,</span> <span class="n">flip</span><span class="p">((</span><span class="n">n</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">coef</span><span class="o">-</span><span class="n">miny</span><span class="p">)),</span> <span class="n">n</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;mm&quot;</span><span class="p">)</span>

        <span class="n">font_fname</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;uxsim&#39;</span><span class="p">,</span> <span class="s1">&#39;utils/Inconsolata.otf&#39;</span><span class="p">)</span>
        <span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="n">font_fname</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">20</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;t = </span><span class="si">{</span><span class="n">t</span><span class="w"> </span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> (s)&quot;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;mm&quot;</span><span class="p">)</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="nb">int</span><span class="p">((</span><span class="n">maxx</span><span class="o">-</span><span class="n">minx</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">maxy</span><span class="o">-</span><span class="n">miny</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span><span class="p">)),</span> <span class="n">resample</span><span class="o">=</span><span class="n">Resampling</span><span class="o">.</span><span class="n">LANCZOS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">image_return</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">img</span>
        <span class="k">elif</span> <span class="n">tmp_anim</span><span class="p">:</span>
            <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/tmp_anim_</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">save_mode</span><span class="p">:</span>
                <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/network</span><span class="si">{</span><span class="n">detailed</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Analyzer.show_simulation_progress"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.show_simulation_progress">[docs]</a>    <span class="nd">@catch_exceptions_and_warn</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">show_simulation_progress</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print simulation progress.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">print_mode</span><span class="p">:</span>
            <span class="n">vehs</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">density</span><span class="o">*</span><span class="n">l</span><span class="o">.</span><span class="n">length</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">]</span>
            <span class="n">sum_vehs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">vehs</span><span class="p">)</span>

            <span class="n">vs</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">density</span><span class="o">*</span><span class="n">l</span><span class="o">.</span><span class="n">length</span><span class="o">*</span><span class="n">l</span><span class="o">.</span><span class="n">speed</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sum_vehs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">avev</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span><span class="o">/</span><span class="n">sum_vehs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">avev</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TIME</span><span class="si">:</span><span class="s2">&gt;8.0f</span><span class="si">}</span><span class="s2"> s| </span><span class="si">{</span><span class="n">sum_vehs</span><span class="si">:</span><span class="s2">&gt;8.0f</span><span class="si">}</span><span class="s2"> vehs|  </span><span class="si">{</span><span class="n">avev</span><span class="si">:</span><span class="s2">&gt;4.1f</span><span class="si">}</span><span class="s2"> m/s| </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">sim_start_time</span><span class="si">:</span><span class="s2">8.2f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Analyzer.network_anim"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.network_anim">[docs]</a>    <span class="nd">@catch_exceptions_and_warn</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">network_anim</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">animation_speed_inverse</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">detailed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minwidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">maxwidth</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">left_handed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">network_font_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">timestep_skip</span><span class="o">=</span><span class="mi">24</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates an animation of the entire transportation network and its traffic states over time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        animation_speed_inverse : int, optional</span>
<span class="sd">            The inverse of the animation speed. A higher value will result in a slower animation. Default is 10.</span>
<span class="sd">        detailed : int, optional</span>
<span class="sd">            Determines the level of detail in the animation.</span>
<span class="sd">            If set to 1, the link internals (cell) are displayed in detail.</span>
<span class="sd">            Under some conditions, the detailed mode will produce inappropriate visualization.</span>
<span class="sd">            If set to 0, the visualization is simplified to link-level. Default is 0.</span>
<span class="sd">        minwidth : float, optional</span>
<span class="sd">            The minimum width of the link visualization in the animation. Default is 0.5.</span>
<span class="sd">        maxwidth : float, optional</span>
<span class="sd">            The maximum width of the link visualization in the animation. Default is 12.</span>
<span class="sd">        left_handed : int, optional</span>
<span class="sd">            If set to 1, the left-handed traffic system (e.g., Japan, UK) is used. If set to 0, the right-handed one is used. Default is 1.</span>
<span class="sd">        figsize : tuple of int, optional</span>
<span class="sd">            The size of the figures in the animation. Default is (6, 6).</span>
<span class="sd">        node_size : int, optional</span>
<span class="sd">            The size of the nodes in the animation. Default is 2.</span>
<span class="sd">        network_font_size : int, optional</span>
<span class="sd">            The font size for the network labels in the animation. Default is 20.</span>
<span class="sd">        timestep_skip : int, optional</span>
<span class="sd">            How many timesteps are skipped per frame. Large value means coarse and lightweight animation. Default is 8.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method generates an animation visualizing the entire transportation network and its traffic conditions over time.</span>
<span class="sd">        The animation provides information on vehicle density, velocity, link names, node locations, and more.</span>
<span class="sd">        The generated animation is saved to the directory `out&lt;W.name&gt;` with a filename based on the `detailed` parameter.</span>

<span class="sd">        Temporary images used to create the animation are removed after the animation is generated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; generating animation...&quot;</span><span class="p">)</span>
        <span class="n">pics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="o">*</span><span class="n">timestep_skip</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">print_mode</span><span class="o">==</span><span class="mi">0</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">edie_dt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">k_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">detailed</span><span class="p">:</span>
                    <span class="c1">#todo_later: 今後はこちらもpillowにする</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">network</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">detailed</span><span class="o">=</span><span class="n">detailed</span><span class="p">,</span> <span class="n">minwidth</span><span class="o">=</span><span class="n">minwidth</span><span class="p">,</span> <span class="n">maxwidth</span><span class="o">=</span><span class="n">maxwidth</span><span class="p">,</span> <span class="n">left_handed</span><span class="o">=</span><span class="n">left_handed</span><span class="p">,</span> <span class="n">tmp_anim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="n">node_size</span><span class="p">,</span> <span class="n">network_font_size</span><span class="o">=</span><span class="n">network_font_size</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">network_pillow</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">detailed</span><span class="o">=</span><span class="n">detailed</span><span class="p">,</span> <span class="n">minwidth</span><span class="o">=</span><span class="n">minwidth</span><span class="p">,</span> <span class="n">maxwidth</span><span class="o">=</span><span class="n">maxwidth</span><span class="p">,</span> <span class="n">left_handed</span><span class="o">=</span><span class="n">left_handed</span><span class="p">,</span> <span class="n">tmp_anim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="n">node_size</span><span class="p">,</span> <span class="n">network_font_size</span><span class="o">=</span><span class="n">network_font_size</span><span class="p">)</span>
                <span class="n">pics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/tmp_anim_</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">))</span>
        <span class="n">pics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/anim_network</span><span class="si">{</span><span class="n">detailed</span><span class="si">}</span><span class="s2">.gif&quot;</span><span class="p">,</span> <span class="n">save_all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">append_images</span><span class="o">=</span><span class="n">pics</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="n">animation_speed_inverse</span><span class="o">*</span><span class="n">timestep_skip</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/tmp_anim_*.png&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Analyzer.network_fancy"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.network_fancy">[docs]</a>    <span class="nd">@catch_exceptions_and_warn</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">network_fancy</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">animation_speed_inverse</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sample_ratio</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">network_font_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">trace_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">speed_coef</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a visually appealing animation of vehicles&#39; trajectories across the entire transportation network over time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        animation_speed_inverse : int, optional</span>
<span class="sd">            The inverse of the animation speed. A higher value will result in a slower animation. Default is 10.</span>
<span class="sd">        figsize : int or tuple of int, optional</span>
<span class="sd">            The size of the figures in the animation. Default is 6.</span>
<span class="sd">        sample_ratio : float, optional</span>
<span class="sd">            The fraction of vehicles to be visualized. Default is 0.3.</span>
<span class="sd">        interval : int, optional</span>
<span class="sd">            The interval at which vehicle positions are sampled. Default is 5.</span>
<span class="sd">        network_font_size : int, optional</span>
<span class="sd">            The font size for the network labels in the animation. Default is 0.</span>
<span class="sd">        trace_length : int, optional</span>
<span class="sd">            The length of the vehicles&#39; trajectory trails in the animation. Default is 3.</span>
<span class="sd">        speed_coef : int, optional</span>
<span class="sd">            A coefficient that adjusts the animation speed. Default is 2.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method generates a visually appealing animation that visualizes vehicles&#39; trajectories across the transportation network over time.</span>
<span class="sd">        The animation provides information on vehicle positions, speeds, link names, node locations, and more, with Bezier curves used for smooth transitions.</span>
<span class="sd">        The generated animation is saved to the directory `out&lt;W.name&gt;` with a filename `anim_network_fancy.gif`.</span>

<span class="sd">        Temporary images used to create the animation are removed after the animation is generated.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; generating animation...&quot;</span><span class="p">)</span>

        <span class="c1"># ベジエ補間</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">make_interp_spline</span>

        <span class="c1">#{t: [&quot;xs&quot;:[], &quot;ys&quot;:[], &quot;v&quot;: v, &quot;c&quot;:c]}</span>
        <span class="n">draw_dict</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[])</span>

        <span class="n">maxx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">minx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">dcoef</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxx</span><span class="o">-</span><span class="n">minx</span><span class="p">)</span><span class="o">/</span><span class="mi">20</span>

        <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">sample_ratio</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">dcoef</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">dcoef</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">log_t</span><span class="p">),</span> <span class="n">interval</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">veh</span><span class="o">.</span><span class="n">log_state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;run&quot;</span><span class="p">:</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">log_link</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">x0</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">x</span><span class="o">+</span><span class="n">dx</span>
                    <span class="n">y0</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">y</span><span class="o">+</span><span class="n">dy</span>
                    <span class="n">x1</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">x</span><span class="o">+</span><span class="n">dx</span>
                    <span class="n">y1</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">y</span><span class="o">+</span><span class="n">dy</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">log_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">link</span><span class="o">.</span><span class="n">length</span>
                    <span class="n">ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">log_t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span><span class="o">+</span><span class="n">x1</span><span class="o">*</span><span class="n">alpha</span><span class="p">)</span>
                    <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span><span class="o">+</span><span class="n">y1</span><span class="o">*</span><span class="n">alpha</span><span class="p">)</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">color</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">log_t</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">veh</span><span class="o">.</span><span class="n">log_state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;run&quot;</span><span class="p">:</span>
                    <span class="n">vs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">log_v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">veh</span><span class="o">.</span><span class="n">log_link</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">u</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">interval</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># 点列</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

            <span class="c1"># x, y 座標を取得</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

            <span class="c1"># ベジエ曲線による補間</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">))</span>
            <span class="n">interp_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">*</span><span class="n">interval</span>
            <span class="n">t_smooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">interp_size</span><span class="p">)</span>
            <span class="n">bezier_spline</span> <span class="o">=</span> <span class="n">make_interp_spline</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">smooth_points</span> <span class="o">=</span> <span class="n">bezier_spline</span><span class="p">(</span><span class="n">t_smooth</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lange</span><span class="p">(</span><span class="n">t_smooth</span><span class="p">):</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="n">trace_length</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">vs</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">vs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">vs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">draw_dict</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;xs&quot;</span><span class="p">:</span> <span class="n">smooth_points</span><span class="p">[</span><span class="n">ii</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="s2">&quot;ys&quot;</span><span class="p">:</span> <span class="n">smooth_points</span><span class="p">[</span><span class="n">ii</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="n">veh</span><span class="o">.</span><span class="n">color</span><span class="p">,</span>
                    <span class="s2">&quot;v&quot;</span><span class="p">:</span> <span class="n">v</span>
                <span class="p">})</span>

        <span class="c1"># 可視化</span>
        <span class="n">maxx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">minx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">maxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">miny</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="n">figsize</span><span class="o">*</span><span class="mi">100</span><span class="o">*</span><span class="n">scale</span><span class="o">/</span><span class="p">(</span><span class="n">maxx</span><span class="o">-</span><span class="n">minx</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="o">*</span><span class="n">scale</span><span class="o">/</span><span class="p">(</span><span class="n">maxx</span><span class="o">-</span><span class="n">minx</span><span class="p">)</span>
        <span class="n">maxx</span> <span class="o">*=</span> <span class="n">coef</span>
        <span class="n">minx</span> <span class="o">*=</span> <span class="n">coef</span>
        <span class="n">maxy</span> <span class="o">*=</span> <span class="n">coef</span>
        <span class="n">miny</span> <span class="o">*=</span> <span class="n">coef</span>

        <span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxx</span><span class="o">-</span><span class="n">minx</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span>
        <span class="n">maxx</span> <span class="o">+=</span> <span class="n">buffer</span>
        <span class="n">minx</span> <span class="o">-=</span> <span class="n">buffer</span>
        <span class="n">maxy</span> <span class="o">+=</span> <span class="n">buffer</span>
        <span class="n">miny</span> <span class="o">-=</span> <span class="n">buffer</span>

        <span class="n">pics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="o">*</span><span class="mi">0</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="o">*</span><span class="mi">1</span><span class="p">),</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="o">*</span><span class="n">speed_coef</span><span class="p">)):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;RGBA&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">maxx</span><span class="o">-</span><span class="n">minx</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxy</span><span class="o">-</span><span class="n">miny</span><span class="p">)),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
            <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">font_fname</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;uxsim&#39;</span><span class="p">,</span> <span class="s1">&#39;utils/Inconsolata.otf&#39;</span><span class="p">)</span>
            <span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="n">font_fname</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">network_font_size</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">flip</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span>

            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
                <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">coef</span><span class="o">-</span><span class="n">minx</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">coef</span><span class="o">-</span><span class="n">miny</span>
                <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">coef</span><span class="o">-</span><span class="n">minx</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">coef</span><span class="o">-</span><span class="n">miny</span>
                <span class="n">draw</span><span class="o">.</span><span class="n">line</span><span class="p">([(</span><span class="n">x1</span><span class="p">,</span> <span class="n">flip</span><span class="p">(</span><span class="n">y1</span><span class="p">)),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">flip</span><span class="p">(</span><span class="n">y2</span><span class="p">))],</span> <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">200</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">joint</span><span class="o">=</span><span class="s2">&quot;curve&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">network_font_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">(((</span><span class="n">x1</span><span class="o">+</span><span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">flip</span><span class="p">((</span><span class="n">y1</span><span class="o">+</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span> <span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;mm&quot;</span><span class="p">)</span>

            <span class="n">traces</span> <span class="o">=</span> <span class="n">draw_dict</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
                <span class="n">xs</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="s2">&quot;xs&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">coef</span><span class="o">-</span><span class="n">minx</span>
                <span class="n">ys</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="s2">&quot;ys&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">coef</span><span class="o">-</span><span class="n">miny</span>
                <span class="n">size</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">])</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">flip</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)]</span>
                <span class="n">draw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span>
                          <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">255</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">255</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">255</span><span class="p">)),</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">joint</span><span class="o">=</span><span class="s2">&quot;curve&quot;</span><span class="p">)</span>
                <span class="n">draw</span><span class="o">.</span><span class="n">ellipse</span><span class="p">((</span><span class="n">xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">size</span><span class="p">,</span> <span class="n">flip</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">size</span><span class="p">,</span> <span class="n">xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">size</span><span class="p">,</span> <span class="n">flip</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">size</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">255</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">255</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">255</span><span class="p">)))</span>
                <span class="c1">#draw.line([(x1, flip(y1)), (xmid1, flip(ymid1)), (xmid2, flip(ymid2)), (x2, flip(y2))]</span>

            <span class="n">font_fname</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;uxsim&#39;</span><span class="p">,</span> <span class="s1">&#39;utils/Inconsolata.otf&#39;</span><span class="p">)</span>
            <span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="n">font_fname</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span>
            <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">20</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;t = </span><span class="si">{</span><span class="n">t</span><span class="w"> </span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> (s)&quot;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;mm&quot;</span><span class="p">)</span>

            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="nb">int</span><span class="p">((</span><span class="n">maxx</span><span class="o">-</span><span class="n">minx</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">maxy</span><span class="o">-</span><span class="n">miny</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span><span class="p">)),</span> <span class="n">resample</span><span class="o">=</span><span class="n">Resampling</span><span class="o">.</span><span class="n">LANCZOS</span><span class="p">)</span>
            <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/tmp_anim_</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
            <span class="n">pics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/tmp_anim_</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">))</span>

        <span class="n">pics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/anim_network_fancy.gif&quot;</span><span class="p">,</span> <span class="n">save_all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">append_images</span><span class="o">=</span><span class="n">pics</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="n">animation_speed_inverse</span><span class="o">*</span><span class="n">speed_coef</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/tmp_anim_*.png&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Analyzer.compute_mfd"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.compute_mfd">[docs]</a>    <span class="k">def</span> <span class="nf">compute_mfd</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute network average flow and density for MFD.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">compute_edie_state</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">links</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">links</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span>
        <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">]</span>
        <span class="n">links</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">Q_AREA</span><span class="p">[</span><span class="n">links</span><span class="p">])):</span>
            <span class="n">tn</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">tn_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span> <span class="k">if</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">links</span><span class="p">])</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">dn_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span> <span class="k">if</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">links</span><span class="p">])</span>
            <span class="n">an</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">length</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">EULAR_DT</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span> <span class="k">if</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">links</span><span class="p">])</span>
            <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">K_AREA</span><span class="p">[</span><span class="n">links</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tn</span><span class="o">/</span><span class="n">an</span>
            <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">Q_AREA</span><span class="p">[</span><span class="n">links</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dn</span><span class="o">/</span><span class="n">an</span></div>

<div class="viewcode-block" id="Analyzer.macroscopic_fundamental_diagram"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.macroscopic_fundamental_diagram">[docs]</a>    <span class="nd">@catch_exceptions_and_warn</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">macroscopic_fundamental_diagram</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">qmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figtitle</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the Macroscopic Fundamental Diagram (MFD) for the provided links.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kappa : float, optional</span>
<span class="sd">            The maximum network average density for the x-axis of the MFD plot. Default is 0.2.</span>
<span class="sd">        qmax : float, optional</span>
<span class="sd">            The maximum network average flow for the y-axis of the MFD plot. Default is 1.</span>
<span class="sd">        links : list or object, optional</span>
<span class="sd">            A list of links or a single link for which the MFD is to be plotted.</span>
<span class="sd">            If not provided, the MFD for all the links in the network will be plotted.</span>
<span class="sd">        fname : str</span>
<span class="sd">            File name for saving (postfix). Default is &quot;&quot;.</span>
<span class="sd">        figsize : tuple of int, optional</span>
<span class="sd">            The size of the figure to be plotted. Default is (4, 4).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method plots the Macroscopic Fundamental Diagram (MFD) for the provided links.</span>
<span class="sd">        The MFD provides a relationship between the network average density and the network average flow.</span>
<span class="sd">        The plot is saved to the directory `out&lt;W.name&gt;` with the filename `mfd&lt;fname&gt;.png`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">links</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">links</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span>
        <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">]</span>
        <span class="n">links</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">compute_mfd</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">figtitle</span><span class="si">}</span><span class="s2"> (# of links: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">K_AREA</span><span class="p">[</span><span class="n">links</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">Q_AREA</span><span class="p">[</span><span class="n">links</span><span class="p">],</span> <span class="s2">&quot;ko-&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;network average density (veh/m)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;network average flow (veh/s)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">kappa</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">qmax</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">save_mode</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/mfd</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">show_mode</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Analyzer.plot_vehicle_log"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.plot_vehicle_log">[docs]</a>    <span class="nd">@catch_exceptions_and_warn</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">plot_vehicle_log</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">vehname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the driving link and speed for a single vehicle.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vehname : str</span>
<span class="sd">            The name of the vehicle for which the driving link and speed are to be plotted.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method visualizes the speed profile and the links traversed by a specific vehicle over time.</span>
<span class="sd">        The speed is plotted on the primary y-axis, and the links are plotted on the secondary y-axis.</span>
<span class="sd">        The plot is saved to the directory `out&lt;W.name&gt;` with the filename `vehicle_&lt;vehname&gt;.png`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">veh</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span><span class="p">[</span><span class="n">vehname</span><span class="p">]</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;vehicle: </span><span class="si">{</span><span class="n">veh</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">log_t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">veh</span><span class="o">.</span><span class="n">log_v</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;speed (m/s)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time (s)&quot;</span><span class="p">)</span>

        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">vehlinks</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;not in network&quot;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">veh</span><span class="o">.</span><span class="n">log_link</span><span class="p">]</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">veh</span><span class="o">.</span><span class="n">log_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lange</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">log_t</span><span class="p">)</span> <span class="k">if</span> <span class="n">veh</span><span class="o">.</span><span class="n">log_state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;home&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">vehlinks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lange</span><span class="p">(</span><span class="n">vehlinks</span><span class="p">)</span> <span class="k">if</span> <span class="n">veh</span><span class="o">.</span><span class="n">log_state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;home&quot;</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">save_mode</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/vehicle_</span><span class="si">{</span><span class="n">vehname</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">show_mode</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Analyzer.vehicles_to_pandas"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.vehicles_to_pandas">[docs]</a>    <span class="k">def</span> <span class="nf">vehicles_to_pandas</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the vehicle travel logs to a pandas DataFrame.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            A DataFrame containing the travel logs of vehicles, with the columns:</span>
<span class="sd">            - &#39;name&#39;: the name of the vehicle (platoon).</span>
<span class="sd">            - &#39;dn&#39;: the platoon size.</span>
<span class="sd">            - &#39;orig&#39;: the origin node of the vehicle&#39;s trip.</span>
<span class="sd">            - &#39;dest&#39;: the destination node of the vehicle&#39;s trip.</span>
<span class="sd">            - &#39;t&#39;: the timestep.</span>
<span class="sd">            - &#39;link&#39;: the link the vehicle is on (or relevant status).</span>
<span class="sd">            - &#39;x&#39;: the position of the vehicle on the link.</span>
<span class="sd">            - &#39;s&#39;: the spacing of the vehicle.</span>
<span class="sd">            - &#39;v&#39;: the speed of the vehicle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">flag_pandas_convert</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">flag_pandas_convert</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">out</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;dn&quot;</span><span class="p">,</span> <span class="s2">&quot;orig&quot;</span><span class="p">,</span> <span class="s2">&quot;dest&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">log_t</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">veh</span><span class="o">.</span><span class="n">log_state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;wait&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;abort&quot;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">veh</span><span class="o">.</span><span class="n">log_link</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">linkname</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">log_link</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">veh</span><span class="o">.</span><span class="n">log_state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;wait&quot;</span><span class="p">:</span>
                                <span class="n">linkname</span> <span class="o">=</span> <span class="s2">&quot;waiting_at_origin_node&quot;</span>
                            <span class="k">elif</span> <span class="n">veh</span><span class="o">.</span><span class="n">log_state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;abort&quot;</span><span class="p">:</span>
                                <span class="n">linkname</span> <span class="o">=</span> <span class="s2">&quot;trip_aborted&quot;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">linkname</span> <span class="o">=</span> <span class="s2">&quot;trip_end&quot;</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">veh</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">,</span> <span class="n">veh</span><span class="o">.</span><span class="n">orig</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">veh</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">veh</span><span class="o">.</span><span class="n">log_t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linkname</span><span class="p">,</span> <span class="n">veh</span><span class="o">.</span><span class="n">log_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">veh</span><span class="o">.</span><span class="n">log_s</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">veh</span><span class="o">.</span><span class="n">log_v</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="n">s</span><span class="o">.</span><span class="n">df_vehicles</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">columns</span><span class="o">=</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">df_vehicles</span></div>

<div class="viewcode-block" id="Analyzer.log_vehicles_to_pandas"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.log_vehicles_to_pandas">[docs]</a>    <span class="k">def</span> <span class="nf">log_vehicles_to_pandas</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        same to `vehicles_to_pandas`, just for backward compatibility</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">vehicles_to_pandas</span><span class="p">()</span></div>

<div class="viewcode-block" id="Analyzer.basic_to_pandas"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.basic_to_pandas">[docs]</a>    <span class="k">def</span> <span class="nf">basic_to_pandas</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the basic stats to a pandas DataFrame.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;total_trips&quot;</span><span class="p">,</span> <span class="s2">&quot;completed_trips&quot;</span><span class="p">,</span> <span class="s2">&quot;total_travel_time&quot;</span><span class="p">,</span> <span class="s2">&quot;average_travel_time&quot;</span><span class="p">,</span> <span class="s2">&quot;total_delay&quot;</span><span class="p">,</span> <span class="s2">&quot;average_delay&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">trip_all</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">trip_completed</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">total_travel_time</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">average_travel_time</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">total_delay</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">average_delay</span><span class="p">]]</span>

        <span class="n">s</span><span class="o">.</span><span class="n">df_basic</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">columns</span><span class="o">=</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">df_basic</span></div>

<div class="viewcode-block" id="Analyzer.od_to_pandas"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.od_to_pandas">[docs]</a>    <span class="k">def</span> <span class="nf">od_to_pandas</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the OD-specific analysis results to a pandas DataFrame.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">s</span><span class="o">.</span><span class="n">od_analysis</span><span class="p">()</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;orig&quot;</span><span class="p">,</span> <span class="s2">&quot;dest&quot;</span><span class="p">,</span> <span class="s2">&quot;total_trips&quot;</span><span class="p">,</span> <span class="s2">&quot;completed_trips&quot;</span><span class="p">,</span> <span class="s2">&quot;free_travel_time&quot;</span><span class="p">,</span> <span class="s2">&quot;average_travel_time&quot;</span><span class="p">,</span> <span class="s2">&quot;stddiv_travel_time&quot;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">o</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">od_trips</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">od_trips</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">d</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">od_trips_comp</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">d</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">od_tt_free</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">d</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">od_tt_ave</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">d</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">od_tt_std</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">d</span><span class="p">]])</span>

        <span class="n">s</span><span class="o">.</span><span class="n">df_od</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">columns</span><span class="o">=</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">df_od</span></div>

<div class="viewcode-block" id="Analyzer.mfd_to_pandas"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.mfd_to_pandas">[docs]</a>    <span class="k">def</span> <span class="nf">mfd_to_pandas</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the MFD to a pandas DataFrame.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">links</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">links</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span>
        <span class="n">s</span><span class="o">.</span><span class="n">compute_mfd</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>
        <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">]</span>
        <span class="n">links</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;network_k&quot;</span><span class="p">,</span> <span class="s2">&quot;network_q&quot;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lange</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">K_AREA</span><span class="p">):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">EULAR_DT</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">K_AREA</span><span class="p">[</span><span class="n">links</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">Q_AREA</span><span class="p">[</span><span class="n">links</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">s</span><span class="o">.</span><span class="n">df_mfd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">columns</span><span class="o">=</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">df_mfd</span></div>

<div class="viewcode-block" id="Analyzer.link_to_pandas"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.link_to_pandas">[docs]</a>    <span class="k">def</span> <span class="nf">link_to_pandas</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the link-level analysis results to a pandas DataFrame.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">link_analysis_coarse</span><span class="p">()</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="s2">&quot;traffic_volume&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicles_remain&quot;</span><span class="p">,</span> <span class="s2">&quot;free_travel_time&quot;</span><span class="p">,</span> <span class="s2">&quot;average_travel_time&quot;</span><span class="p">,</span> <span class="s2">&quot;stddiv_travel_time&quot;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">linkc_volume</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">linkc_remain</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">linkc_tt_free</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">linkc_tt_ave</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">linkc_tt_std</span><span class="p">[</span><span class="n">l</span><span class="p">]])</span>
        <span class="n">s</span><span class="o">.</span><span class="n">df_linkc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">columns</span><span class="o">=</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">df_linkc</span></div>

<div class="viewcode-block" id="Analyzer.link_traffic_state_to_pandas"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.link_traffic_state_to_pandas">[docs]</a>    <span class="k">def</span> <span class="nf">link_traffic_state_to_pandas</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the traffic states in links to a pandas DataFrame.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">compute_edie_state</span><span class="p">()</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;delta_t&quot;</span><span class="p">,</span> <span class="s2">&quot;delta_x&quot;</span><span class="p">,</span> <span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">k_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">k_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="n">l</span><span class="o">.</span><span class="n">edie_dt</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="n">l</span><span class="o">.</span><span class="n">edie_dx</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">edie_dt</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">edie_dx</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">q_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">l</span><span class="o">.</span><span class="n">k_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">l</span><span class="o">.</span><span class="n">v_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]])</span>
        <span class="n">s</span><span class="o">.</span><span class="n">df_link_traffic_state</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">columns</span><span class="o">=</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">df_link_traffic_state</span></div>

<div class="viewcode-block" id="Analyzer.link_cumulative_to_pandas"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.link_cumulative_to_pandas">[docs]</a>    <span class="k">def</span> <span class="nf">link_cumulative_to_pandas</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the cumulative counts etc. in links to a pandas DataFrame.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;arrival_count&quot;</span><span class="p">,</span> <span class="s2">&quot;departure_count&quot;</span><span class="p">,</span> <span class="s2">&quot;actual_travel_time&quot;</span><span class="p">,</span> <span class="s2">&quot;instantanious_travel_time&quot;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span><span class="p">):</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">link</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">,</span> <span class="n">link</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">link</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">link</span><span class="o">.</span><span class="n">traveltime_actual</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">link</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">s</span><span class="o">.</span><span class="n">df_link_cumulative</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">columns</span><span class="o">=</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">df_link_cumulative</span></div>

<div class="viewcode-block" id="Analyzer.output_data"><a class="viewcode-back" href="../../uxsim.html#uxsim.Analyzer.output_data">[docs]</a>    <span class="nd">@catch_exceptions_and_warn</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">output_data</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save all results to CSV files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/data&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">basic_to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname</span><span class="o">+</span><span class="s2">&quot;_basic.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">od_to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname</span><span class="o">+</span><span class="s2">&quot;_od.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">mfd_to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname</span><span class="o">+</span><span class="s2">&quot;_mfd.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">link_to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname</span><span class="o">+</span><span class="s2">&quot;_link.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">link_traffic_state_to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname</span><span class="o">+</span><span class="s2">&quot;_link_traffic_state.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">vehicles_to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname</span><span class="o">+</span><span class="s2">&quot;_vehicles.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div></div>

<span class="c1"># 経路クラス</span>
<div class="viewcode-block" id="Route"><a class="viewcode-back" href="../../uxsim.html#uxsim.Route">[docs]</a><span class="k">class</span> <span class="nc">Route</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for a route that store concective links.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Route.__init__"><a class="viewcode-back" href="../../_autosummary/uxsim.Route.html#uxsim.Route.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">trust_input</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define a route.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        links : list</span>
<span class="sd">            List of links. The contents are Link objects.</span>
<span class="sd">        links_name : list</span>
<span class="sd">            List of name of links. The contents are str.</span>
<span class="sd">        trust_input : bool</span>
<span class="sd">            True if you trust the `links` in order to reduce the computation cost by omitting verification.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>
        <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">s</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">trust_input</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1">#入力データを検査する場合</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">l2</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">l2</span> <span class="ow">in</span> <span class="n">l1</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">outlinks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route is not defined by concective links: </span><span class="si">{</span><span class="n">links</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">l1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1">#todo: interpolation based on shotest path</span>
            <span class="n">s</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#検査せずそのまま使用（計算コスト削減）</span>
            <span class="n">s</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="n">links</span>
        <span class="n">s</span><span class="o">.</span><span class="n">links_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">links</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Route </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">links</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override `==` operator. If the links of two route are the same, then the routes are the same.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Route</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">links</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

<div class="viewcode-block" id="Route.actual_travel_time"><a class="viewcode-back" href="../../uxsim.html#uxsim.Route.actual_travel_time">[docs]</a>    <span class="k">def</span> <span class="nf">actual_travel_time</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">return_details</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Actual travel time for a (hypothetical) vehicle who start traveling this route on time t.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t : float</span>
<span class="sd">            Time in seconds.</span>
<span class="sd">        return_details : bool</span>
<span class="sd">            True if you want travel time per link.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The actual travel time.</span>
<span class="sd">        list (if `return_details` is True)</span>
<span class="sd">            List of travel time per link.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">tts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="n">link_tt</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">actual_travel_time</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">tt</span> <span class="o">+=</span> <span class="n">link_tt</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">link_tt</span>
            <span class="n">tts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link_tt</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_details</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tt</span><span class="p">,</span> <span class="n">tts</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tt</span></div></div>

<div class="viewcode-block" id="OSMImporter"><a class="viewcode-back" href="../../uxsim.html#uxsim.OSMImporter">[docs]</a><span class="k">class</span> <span class="nc">OSMImporter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    OpenStreetMap importer using OSMnx.</span>
<span class="sd">    Work in progress. Import from OSM is experimental and may not work as expected. It is functional but produces inappropriate networks for simulation, such as too many nodes, too many deadends, fragmented networks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="OSMImporter.import_osm_data"><a class="viewcode-back" href="../../uxsim.html#uxsim.OSMImporter.import_osm_data">[docs]</a>    <span class="k">def</span> <span class="nf">import_osm_data</span><span class="p">(</span><span class="n">north</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">west</span><span class="p">,</span> <span class="n">custom_filter</span><span class="o">=</span><span class="s1">&#39;[&quot;highway&quot;~&quot;trunk|primary&quot;]&#39;</span><span class="p">,</span> 
                        <span class="n">default_number_of_lanes_mortorway</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">default_number_of_lanes_trunk</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
                        <span class="n">default_number_of_lanes_primary</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default_number_of_lanes_secondary</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                        <span class="n">default_number_of_lanes_residential</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">default_number_of_lanes_tertiary</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                        <span class="n">default_number_of_lanes_others</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                        <span class="n">default_maxspeed_mortorway</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">default_maxspeed_trunk</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> 
                        <span class="n">default_maxspeed_primary</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">default_maxspeed_secondary</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> 
                        <span class="n">default_maxspeed_residential</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">default_maxspeed_tertiary</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> 
                        <span class="n">default_maxspeed_others</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Import road network data from OpenStreetMap using OSMnx.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        north, south, east, west: float</span>
<span class="sd">            The latitudes and longitudes of the area to be imported.</span>
<span class="sd">        custom_filter: str</span>
<span class="sd">            The filter to be used for importing the data. </span>
<span class="sd">            The default is &#39;[&quot;highway&quot;~&quot;trunk|primary&quot;]&#39;, which means that only trunk and primary roads (usually correspond to major arterial roads) are imported.</span>
<span class="sd">        default_number_of_lanes_*: int</span>
<span class="sd">            The default number of lanes for * {road_type}.</span>
<span class="sd">        default_maxspeed_*: float</span>
<span class="sd">            The default maximum speed for * {road_type}.    </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        links: list</span>
<span class="sd">            A list of links, where each element is a list of [name, from, to, lanes, maxspeed].</span>
<span class="sd">        nodes: dict</span>
<span class="sd">            A dictionary of nodes, where the key is the node ID and the value is a list of [node_id, x, y].</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#experimental warning</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Import from OSM is experimental and may not work as expected. It is functional but produces inappropriate networks for simulation, such as too many nodes, too many deadends, fragmented networks.&quot;</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Import from OSM is experimental and may not work as expected. It is functional but produces inappropriate networks for simulation, such as too many nodes, too many deadends, fragmented networks.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">osmnx</span> <span class="k">as</span> <span class="nn">ox</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Optional module &#39;osmnx&#39; is not installed. Please install it by &#39;pip install osmnx&#39; to use this function.&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Start downloading OSM data. This may take some time.&quot;</span><span class="p">)</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">graph_from_bbox</span><span class="p">(</span><span class="n">north</span><span class="o">=</span><span class="n">north</span><span class="p">,</span> <span class="n">south</span><span class="o">=</span><span class="n">south</span><span class="p">,</span> <span class="n">east</span><span class="o">=</span><span class="n">east</span><span class="p">,</span> <span class="n">west</span><span class="o">=</span><span class="n">west</span><span class="p">,</span> <span class="n">network_type</span><span class="o">=</span><span class="s2">&quot;drive&quot;</span><span class="p">,</span> 
                                    <span class="n">custom_filter</span><span class="o">=</span><span class="n">custom_filter</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Download completed&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        motorway: 高速道路</span>
<span class="sd">        trunk: 一般国道</span>
<span class="sd">        primary: 主要地方道（2桁番号県道・市道）</span>
<span class="sd">        secondary: 一般地方道（3桁番号県道・市道）</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># データ抽出</span>
        <span class="n">node_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">nd</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">node_dict</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">nd</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">nd</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]]</span>

        <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">ed</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="s2">&quot;highway&quot;</span> <span class="ow">in</span> <span class="n">ed</span><span class="p">:</span>
                <span class="n">road_type</span> <span class="o">=</span> <span class="n">ed</span><span class="p">[</span><span class="s2">&quot;highway&quot;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">ed</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">osmid</span> <span class="o">=</span> <span class="n">ed</span><span class="p">[</span><span class="s2">&quot;osmid&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">osmid</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="n">osmid</span> <span class="o">=</span> <span class="n">osmid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">name</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">osmid</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">osmid</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">lanes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ed</span><span class="p">[</span><span class="s2">&quot;lanes&quot;</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;mortorway&quot;</span> <span class="ow">in</span> <span class="n">road_type</span><span class="p">:</span>
                            <span class="n">lanes</span> <span class="o">=</span> <span class="n">default_number_of_lanes_mortorway</span>
                        <span class="k">elif</span> <span class="s2">&quot;trunk&quot;</span> <span class="ow">in</span> <span class="n">road_type</span><span class="p">:</span>
                            <span class="n">lanes</span> <span class="o">=</span> <span class="n">default_number_of_lanes_trunk</span>
                        <span class="k">elif</span> <span class="s2">&quot;primary&quot;</span> <span class="ow">in</span> <span class="n">road_type</span><span class="p">:</span>
                            <span class="n">lanes</span> <span class="o">=</span> <span class="n">default_number_of_lanes_primary</span>
                        <span class="k">elif</span> <span class="s2">&quot;secondary&quot;</span> <span class="ow">in</span> <span class="n">road_type</span><span class="p">:</span>
                            <span class="n">lanes</span> <span class="o">=</span> <span class="n">default_number_of_lanes_secondary</span>
                        <span class="k">elif</span> <span class="s2">&quot;residential&quot;</span> <span class="ow">in</span> <span class="n">road_type</span><span class="p">:</span>
                            <span class="n">lanes</span> <span class="o">=</span> <span class="n">default_number_of_lanes_residential</span>
                        <span class="k">elif</span> <span class="s2">&quot;tertiary&quot;</span> <span class="ow">in</span> <span class="n">road_type</span><span class="p">:</span>
                            <span class="n">lanes</span> <span class="o">=</span> <span class="n">default_number_of_lanes_tertiary</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lanes</span> <span class="o">=</span> <span class="n">default_number_of_lanes_others</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">lanes</span> <span class="o">=</span> <span class="n">default_number_of_lanes_others</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">maxspeed</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ed</span><span class="p">[</span><span class="s2">&quot;maxspeed&quot;</span><span class="p">])</span><span class="o">/</span><span class="mf">3.6</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;mortorway&quot;</span> <span class="ow">in</span> <span class="n">road_type</span><span class="p">:</span>
                            <span class="n">maxspeed</span> <span class="o">=</span> <span class="n">default_maxspeed_mortorway</span><span class="o">/</span><span class="mf">3.6</span>
                        <span class="k">elif</span> <span class="s2">&quot;trunk&quot;</span> <span class="ow">in</span> <span class="n">road_type</span><span class="p">:</span>
                            <span class="n">maxspeed</span> <span class="o">=</span> <span class="n">default_maxspeed_trunk</span><span class="o">/</span><span class="mf">3.6</span>
                        <span class="k">elif</span> <span class="s2">&quot;primary&quot;</span> <span class="ow">in</span> <span class="n">road_type</span><span class="p">:</span>
                            <span class="n">maxspeed</span> <span class="o">=</span> <span class="n">default_maxspeed_primary</span><span class="o">/</span><span class="mf">3.6</span>
                        <span class="k">elif</span> <span class="s2">&quot;secondary&quot;</span> <span class="ow">in</span> <span class="n">road_type</span><span class="p">:</span>
                            <span class="n">maxspeed</span> <span class="o">=</span> <span class="n">default_maxspeed_secondary</span><span class="o">/</span><span class="mf">3.6</span>
                        <span class="k">elif</span> <span class="s2">&quot;residential&quot;</span> <span class="ow">in</span> <span class="n">road_type</span><span class="p">:</span>
                            <span class="n">maxspeed</span> <span class="o">=</span> <span class="n">default_maxspeed_residential</span><span class="o">/</span><span class="mf">3.6</span>
                        <span class="k">elif</span> <span class="s2">&quot;tertiary&quot;</span> <span class="ow">in</span> <span class="n">road_type</span><span class="p">:</span>
                            <span class="n">maxspeed</span> <span class="o">=</span> <span class="n">default_maxspeed_tertiary</span><span class="o">/</span><span class="mf">3.6</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">maxspeed</span> <span class="o">=</span> <span class="n">default_maxspeed_others</span><span class="o">/</span><span class="mf">3.6</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">maxspeed</span> <span class="o">=</span> <span class="n">default_maxspeed_others</span><span class="o">/</span><span class="mf">3.6</span>
            

                <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lanes</span><span class="p">,</span> <span class="n">maxspeed</span><span class="p">])</span> <span class="c1"># name, from, to, number_of_lanes, maxspeed</span>
                <span class="n">nodes</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">node_dict</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">nodes</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">node_dict</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;imported network size:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; number of links:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; number of nodes:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">links</span></div>
                    
<div class="viewcode-block" id="OSMImporter.osm_network_postprocessing"><a class="viewcode-back" href="../../uxsim.html#uxsim.OSMImporter.osm_network_postprocessing">[docs]</a>    <span class="k">def</span> <span class="nf">osm_network_postprocessing</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">node_merge_threshold</span><span class="p">,</span> <span class="n">node_merge_iteration</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">enforce_bidirectional</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Postprocess the network to make it suitable for simulation. First, it aggregates the network by merging nodes that are closer than the threshold. Second, if `enforce_bidirectional` is True, it adds reverse links for each link to eliminate deadend nodes as much as possible.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nodes: list</span>
<span class="sd">            A list of nodes, where each element is a list of [node_id, x, y].</span>
<span class="sd">        links: list </span>
<span class="sd">            A list of links, where each element is a list of [name, from, to, lanes, maxspeed].</span>
<span class="sd">        node_merge_threshold: float</span>
<span class="sd">            If two nodes are connected by a link that is shorter than this threshold, the nodes are merged and the link is removed.</span>
<span class="sd">        node_merge_iteration: int</span>
<span class="sd">            The number of iterations for the node merge.</span>
<span class="sd">        enforce_bidirectional: bool</span>
<span class="sd">            True if you want to enforce bidirectional links. It will automatically add a reverse link for each link. This will eliminate deadend nodes as much as possible, but the original network topology is not preserved rigorously.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        nodes: list</span>
<span class="sd">            A list of nodes, where each element is a list of [node_id, x, y].</span>
<span class="sd">        links: list</span>
<span class="sd">            A list of links, where each element is a list of [name, from, to, lanes, maxspeed].</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#ネットワーク縮約：リンクベース</span>
        <span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">pos1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">node_merge_iteration</span><span class="p">):</span>
            <span class="c1"># ノード座標の辞書を作成</span>
            <span class="n">node_positions</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">}</span>

            <span class="c1"># 長さが node_merge_threshold 以下のリンクを省略し、起点ノードと終点ノードを融合</span>
            <span class="c1">#縮約対象になったノードのマッピング：keyが縮約元，valueが縮約先</span>
            <span class="n">delete_node_map</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">number_of_deleted_links</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
                <span class="n">start_node</span><span class="p">,</span> <span class="n">end_node</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">start_pos</span> <span class="o">=</span> <span class="n">node_positions</span><span class="p">[</span><span class="n">start_node</span><span class="p">]</span>
                <span class="n">end_pos</span> <span class="o">=</span> <span class="n">node_positions</span><span class="p">[</span><span class="n">end_node</span><span class="p">]</span>
                <span class="n">link_length</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">start_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">)</span>
                <span class="c1">#print(link_length, link[0], start_node, end_node)</span>

                <span class="k">if</span> <span class="n">link_length</span> <span class="o">&lt;=</span> <span class="n">node_merge_threshold</span><span class="p">:</span>
                    <span class="c1">#縮約先に登録されていなければ登録</span>
                    <span class="k">if</span> <span class="n">end_node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">delete_node_map</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="ow">and</span> <span class="n">start_node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">delete_node_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">delete_node_map</span><span class="p">[</span><span class="n">end_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_node</span>
                    <span class="k">if</span> <span class="n">start_node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">delete_node_map</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="ow">and</span> <span class="n">end_node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">delete_node_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">delete_node_map</span><span class="p">[</span><span class="n">start_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_node</span>
                    
                    <span class="n">number_of_deleted_links</span> <span class="o">+=</span> <span class="mi">1</span>
                
            <span class="c1"># 新しいノードリストとリンクリストを作成</span>
            <span class="n">new_nodes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">new_links</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">number_of_deleted_nodes</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">number_of_new_nodes</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="c1"># for group in delete_node_groups:</span>
                <span class="c1">#     if node[0] in delete_node_map.keys():</span>
                <span class="c1">#         break</span>
                <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">delete_node_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">number_of_deleted_nodes</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="n">number_of_new_nodes</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">start_node</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">end_node</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">lanes</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">maxspeed</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">start_node</span> <span class="ow">in</span> <span class="n">delete_node_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">start_node</span> <span class="o">=</span> <span class="n">delete_node_map</span><span class="p">[</span><span class="n">start_node</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">end_node</span> <span class="ow">in</span> <span class="n">delete_node_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">end_node</span> <span class="o">=</span> <span class="n">delete_node_map</span><span class="p">[</span><span class="n">end_node</span><span class="p">]</span>

                <span class="n">length</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">node_positions</span><span class="p">[</span><span class="n">start_node</span><span class="p">],</span> <span class="n">node_positions</span><span class="p">[</span><span class="n">end_node</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">start_node</span> <span class="o">!=</span> <span class="n">end_node</span><span class="p">:</span>
                    <span class="n">new_links</span><span class="p">[</span><span class="n">start_node</span><span class="p">,</span> <span class="n">end_node</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">start_node</span><span class="p">,</span> <span class="n">end_node</span><span class="p">,</span> <span class="n">lanes</span><span class="p">,</span> <span class="n">maxspeed</span><span class="p">,</span> <span class="n">length</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">enforce_bidirectional</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_links</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">start_node</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">end_node</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">lanes</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">maxspeed</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">end_node</span><span class="p">,</span> <span class="n">start_node</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_links</span><span class="p">:</span>
                        <span class="n">new_links</span><span class="p">[</span><span class="n">end_node</span><span class="p">,</span> <span class="n">start_node</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;-reverse&quot;</span><span class="p">,</span> <span class="n">end_node</span><span class="p">,</span> <span class="n">start_node</span><span class="p">,</span> <span class="n">lanes</span><span class="p">,</span> <span class="n">maxspeed</span><span class="p">,</span> <span class="n">length</span><span class="p">]</span>

            <span class="n">new_links</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_links</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

            <span class="c1"># 孤立したノードの除去</span>
            <span class="n">used_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">new_links</span><span class="p">:</span>
                <span class="n">used_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">used_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

            <span class="n">new_nodes_used</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">new_nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">used_nodes</span><span class="p">:</span>
                    <span class="n">new_nodes_used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

            <span class="n">new_nodes</span> <span class="o">=</span> <span class="n">new_nodes_used</span>

            <span class="n">nodes</span> <span class="o">=</span> <span class="n">new_nodes</span>
            <span class="n">links</span> <span class="o">=</span> <span class="n">new_links</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;aggregated network size:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; number of links:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; number of nodes:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">links</span></div>

<div class="viewcode-block" id="OSMImporter.osm_network_visualize"><a class="viewcode-back" href="../../uxsim.html#uxsim.OSMImporter.osm_network_visualize">[docs]</a>    <span class="k">def</span> <span class="nf">osm_network_visualize</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span> <span class="n">show_link_name</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualize the imported network. Mainly for test purpose.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">node_positions</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">}</span>

        <span class="c1"># グラフを描画</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>

        <span class="c1"># ノードをプロット</span>
        <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">node_positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># リンクをプロット</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="n">start_node</span><span class="p">,</span> <span class="n">end_node</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">start_pos</span> <span class="o">=</span> <span class="n">node_positions</span><span class="p">[</span><span class="n">start_node</span><span class="p">]</span>
            <span class="n">end_pos</span> <span class="o">=</span> <span class="n">node_positions</span><span class="p">[</span><span class="n">end_node</span><span class="p">]</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">start_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">start_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="n">end_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="n">end_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">y2</span><span class="p">)</span><span class="o">*</span><span class="mf">0.025</span><span class="p">,</span> <span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.025</span>
            <span class="n">xmid1</span><span class="p">,</span> <span class="n">ymid1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x1</span><span class="o">+</span><span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vx</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">y1</span><span class="o">+</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vy</span>
            <span class="n">xmid2</span><span class="p">,</span> <span class="n">ymid2</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vx</span><span class="p">,</span> <span class="p">(</span><span class="n">y1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vy</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">xmid1</span><span class="p">,</span> <span class="n">xmid2</span><span class="p">,</span> <span class="n">x2</span><span class="p">],</span> <span class="p">[</span><span class="n">y1</span><span class="p">,</span> <span class="n">ymid1</span><span class="p">,</span> <span class="n">ymid2</span><span class="p">,</span> <span class="n">y2</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_link_name</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">x1</span><span class="o">+</span><span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">y1</span><span class="o">+</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="OSMImporter.osm_network_to_World"><a class="viewcode-back" href="../../uxsim.html#uxsim.OSMImporter.osm_network_to_World">[docs]</a>    <span class="k">def</span> <span class="nf">osm_network_to_World</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">default_jam_density</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">coef_degree_to_meter</span><span class="o">=</span><span class="mi">111000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the imported network to the World object of UXsim.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nodes: list</span>
<span class="sd">            A list of nodes, where each element is a list of [node_id, x, y].</span>
<span class="sd">        links: list</span>
<span class="sd">            A list of links, where each element is a list of [name, from, to, lanes, maxspeed, length].</span>
<span class="sd">        default_jam_density: float</span>
<span class="sd">            The default jam density for the links.</span>
<span class="sd">        coef_degree_to_meter: float</span>
<span class="sd">            The coefficient to convert lon/lat degree to meter. Default is 111000.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">W</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">x</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="n">W</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">length</span><span class="o">=</span><span class="n">link</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">coef_degree_to_meter</span><span class="p">,</span> <span class="n">free_flow_speed</span><span class="o">=</span><span class="n">link</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">jam_density</span><span class="o">=</span><span class="n">default_jam_density</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="World"><a class="viewcode-back" href="../../uxsim.html#uxsim.World">[docs]</a><span class="k">class</span> <span class="nc">World</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    World (i.e., simulation environment). A World object is consistently referred to as `W` in this code.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="World.__init__"><a class="viewcode-back" href="../../_autosummary/uxsim.uxsim.World.html#uxsim.World.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">deltan</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">reaction_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">duo_update_time</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">duo_update_weight</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">duo_noise</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">eular_dt</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">eular_dx</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">print_mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">save_mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">show_mode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">route_choice_principle</span><span class="o">=</span><span class="s2">&quot;homogeneous_DUO&quot;</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">show_progress_deltat</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a World.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            The name of the world, default is an empty string.</span>
<span class="sd">        deltan : int, optional</span>
<span class="sd">            The platoon size, default is 5 vehicles.</span>
<span class="sd">        reaction_time : float, optional</span>
<span class="sd">            The reaction time, default is 1 second. This is also related to simulation time step width.</span>
<span class="sd">        duo_update_time : float, optional</span>
<span class="sd">            The time interval for route choice update, default is 600 seconds.</span>
<span class="sd">        duo_update_weight : float, optional</span>
<span class="sd">            The update weight for route choice, default is 0.5.</span>
<span class="sd">        duo_noise : float, optional</span>
<span class="sd">            The noise in route choice, default is 0.01.</span>
<span class="sd">        eular_dt : float, optional</span>
<span class="sd">            The time aggregation size for eularian traffic state computation, default is 120.</span>
<span class="sd">        random_seed : int or None, optional</span>
<span class="sd">            The random seed, default is None.</span>
<span class="sd">        print_mode : int, optional</span>
<span class="sd">            The print mode, whether print the simulation progress or not. Default is 1 (enabled).</span>
<span class="sd">        save_mode : int, optional</span>
<span class="sd">            The save mode,. whether save the simulation results or not.  Default is 1 (enabled).</span>
<span class="sd">        show_mode : int, optional</span>
<span class="sd">            The show mode, whether show the matplotlib visualization results or not. Default is 0 (disabled).</span>
<span class="sd">        route_choice_principle : str, optional</span>
<span class="sd">            The route choice principle, default is &quot;homogeneous_DUO&quot;.</span>
<span class="sd">        show_progress : int, optional</span>
<span class="sd">            Whether show network progress, default is 1 (enabled).</span>
<span class="sd">        show_progress_deltat : float, optional</span>
<span class="sd">            The time interval for showing network progress, default is 600 seconds.</span>
<span class="sd">        tmax : float or None, optional</span>
<span class="sd">            The simulation duration, default is None (automatically determined).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        A World object must be defined firstly to initiate simulation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">## パラメータ設定</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>

        <span class="n">W</span><span class="o">.</span><span class="n">TMAX</span> <span class="o">=</span> <span class="n">tmax</span>   <span class="c1">#シミュレーション時間（s）</span>

        <span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span> <span class="o">=</span> <span class="n">deltan</span>         <span class="c1">#車群サイズ（veh）</span>
        <span class="n">W</span><span class="o">.</span><span class="n">REACTION_TIME</span> <span class="o">=</span> <span class="n">reaction_time</span>         <span class="c1">#反応時間（s）</span>

        <span class="n">W</span><span class="o">.</span><span class="n">DUO_UPDATE_TIME</span> <span class="o">=</span> <span class="n">duo_update_time</span>     <span class="c1">#経路選択時間間隔（s）</span>
        <span class="n">W</span><span class="o">.</span><span class="n">DUO_UPDATE_WEIGHT</span> <span class="o">=</span> <span class="n">duo_update_weight</span>    <span class="c1">#経路選択の更新重み</span>
        <span class="n">W</span><span class="o">.</span><span class="n">DUO_NOISE</span> <span class="o">=</span> <span class="n">duo_noise</span>    <span class="c1">#経路選択時のノイズ（完全に対称なネットワークで極端な経路選択になるのを防ぐ）</span>
        <span class="n">W</span><span class="o">.</span><span class="n">EULAR_DT</span> <span class="o">=</span> <span class="n">eular_dt</span>     <span class="c1">#Eular型データのデフォルト時間離散化幅</span>

        <span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">REACTION_TIME</span><span class="o">*</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
        <span class="n">W</span><span class="o">.</span><span class="n">DELTAT_ROUTE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">DUO_UPDATE_TIME</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>

        <span class="c1">## データ格納先定義</span>
        <span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>            <span class="c1">#home, wait, run, end</span>
        <span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_LIVING</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>     <span class="c1">#home, wait, run</span>
        <span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_RUNNING</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>    <span class="c1">#run</span>
        <span class="n">W</span><span class="o">.</span><span class="n">NODES</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">W</span><span class="o">.</span><span class="n">LINKS</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">W</span><span class="o">.</span><span class="n">route_choice_principle</span> <span class="o">=</span> <span class="n">route_choice_principle</span>

        <span class="c1">## リアルタイム経過表示</span>
        <span class="n">W</span><span class="o">.</span><span class="n">show_progress</span> <span class="o">=</span> <span class="n">show_progress</span>
        <span class="n">W</span><span class="o">.</span><span class="n">show_progress_deltat_timestep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">show_progress_deltat</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>

        <span class="c1">## システム設定</span>
        <span class="n">W</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="n">W</span><span class="o">.</span><span class="n">finalized</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">W</span><span class="o">.</span><span class="n">world_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">W</span><span class="o">.</span><span class="n">print_mode</span> <span class="o">=</span> <span class="n">print_mode</span>
        <span class="k">if</span> <span class="n">print_mode</span><span class="p">:</span>
            <span class="n">W</span><span class="o">.</span><span class="n">print</span> <span class="o">=</span> <span class="nb">print</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">noprint</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="n">W</span><span class="o">.</span><span class="n">print</span> <span class="o">=</span> <span class="n">noprint</span>
        <span class="n">W</span><span class="o">.</span><span class="n">save_mode</span> <span class="o">=</span> <span class="n">save_mode</span>
        <span class="n">W</span><span class="o">.</span><span class="n">show_mode</span> <span class="o">=</span> <span class="n">show_mode</span></div>


<div class="viewcode-block" id="World.addNode"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.addNode">[docs]</a>    <span class="k">def</span> <span class="nf">addNode</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        add a node to world</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the node.</span>
<span class="sd">        x : float</span>
<span class="sd">            The x-coordinate of the node (for visualization purposes).</span>
<span class="sd">        y : float</span>
<span class="sd">            The y-coordinate of the node (for visualization purposes).</span>
<span class="sd">        signal : list of int, optional</span>
<span class="sd">            A list representing the signal at the node. Default is [0], representing no signal.</span>
<span class="sd">            If a signal is present, the list contains the green times for each group.</span>
<span class="sd">            For example, `signal`=[60, 10, 50, 5] means that this signal has 4 phases, and green time for the 1st group is 60 s.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        object</span>
<span class="sd">            the added Node object.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function acts as a wrapper for creating a Node object and adding it to the network.</span>
<span class="sd">        It passes all given arguments and keyword arguments to the Node class initialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Node</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="World.addLink"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.addLink">[docs]</a>    <span class="k">def</span> <span class="nf">addLink</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        add a link to world</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the link.</span>
<span class="sd">        start_node : str | Node</span>
<span class="sd">            The name or object of the start node of the link.</span>
<span class="sd">        end_node : str | Node</span>
<span class="sd">            The name or object of the end node of the link.</span>
<span class="sd">        length : float</span>
<span class="sd">            The length of the link.</span>
<span class="sd">        free_flow_speed : float</span>
<span class="sd">            The free flow speed on the link.</span>
<span class="sd">        jam_density : float</span>
<span class="sd">            The jam density on the link.</span>
<span class="sd">        merge_priority : float, optional</span>
<span class="sd">            The priority of the link when merging at the downstream node, default is 1.</span>
<span class="sd">        signal_group : int or list, optional</span>
<span class="sd">            The signal group to which the link belongs, default is 0.</span>
<span class="sd">        capacity_out : float, optional</span>
<span class="sd">            The capacity out of the link, default is calculated based on other parameters.</span>
<span class="sd">        capacity_in : float, optional</span>
<span class="sd">            The capacity into the link, default is calculated based on other parameters.</span>
<span class="sd">        eular_dx : float, optional</span>
<span class="sd">            The default space aggregation size for link traffic state computation, default is None. If None, the global eular_dx value is used.</span>
<span class="sd">        attribute : any, optinonal</span>
<span class="sd">            Additional (meta) attributes defined by users.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        object</span>
<span class="sd">            the added Link object.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function acts as a wrapper for creating a Link object and adding it to the network.</span>
<span class="sd">        It passes all given arguments and keyword arguments to the Link class initialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Link</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="World.addVehicle"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.addVehicle">[docs]</a>    <span class="k">def</span> <span class="nf">addVehicle</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        add a vehicle to world</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orig : str | Node</span>
<span class="sd">            The origin node.</span>
<span class="sd">        dest : str | Node</span>
<span class="sd">            The destination node.</span>
<span class="sd">        departure_time : int</span>
<span class="sd">            The departure time of the vehicle.</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            The name of the vehicle, default is the id of the vehicle.</span>
<span class="sd">        route_pref : dict, optional</span>
<span class="sd">            The preference weights for links, default is 0 for all links.</span>
<span class="sd">        route_choice_principle : str, optional</span>
<span class="sd">            The route choice principle of the vehicle, default is the network&#39;s route choice principle.</span>
<span class="sd">        links_prefer : list of str, optional</span>
<span class="sd">            The names of the links the vehicle prefers, default is empty list.</span>
<span class="sd">        links_avoid : list of str, optional</span>
<span class="sd">            The names of the links the vehicle avoids, default is empty list.</span>
<span class="sd">        trip_abort : int, optional</span>
<span class="sd">            Whether to abort the trip if a dead end is reached, default is 1.</span>
<span class="sd">        attribute : any, optinonal</span>
<span class="sd">            Additional (meta) attributes defined by users.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        object</span>
<span class="sd">            the added Vehicle object.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function acts as a wrapper for creating a Vehicle object and adding it to the network.</span>
<span class="sd">        It passes all given arguments and keyword arguments to the Vehicle class initialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Vehicle</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="World.adddemand"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.adddemand">[docs]</a>    <span class="k">def</span> <span class="nf">adddemand</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">flow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">volume</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate vehicles by specifying time-dependent origin-destination demand.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orig : str | Node</span>
<span class="sd">            The name or object of the origin node.</span>
<span class="sd">        dest : str | Node</span>
<span class="sd">            The name or object of the destination node.</span>
<span class="sd">        t_start : float</span>
<span class="sd">            The start time for the demand in seconds.</span>
<span class="sd">        t_end : float</span>
<span class="sd">            The end time for the demand in seconds.</span>
<span class="sd">        flow : float, optional</span>
<span class="sd">            The flow rate from the origin to the destination in vehicles per second.</span>
<span class="sd">        volume: float, optional</span>
<span class="sd">            The demand volume from the origin to the destination. If volume is specified, the flow is ignored.</span>
<span class="sd">        attribute : any, optinonal</span>
<span class="sd">            Additional (meta) attributes defined by users.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">volume</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">volume</span><span class="o">/</span><span class="p">(</span><span class="n">t_end</span><span class="o">-</span><span class="n">t_start</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">t_start</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">t_end</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)):</span>
            <span class="n">f</span> <span class="o">+=</span> <span class="n">flow</span><span class="o">*</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>
            <span class="k">while</span> <span class="n">f</span> <span class="o">&gt;=</span> <span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">:</span>
                <span class="n">W</span><span class="o">.</span><span class="n">addVehicle</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">departure_time_is_time_step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="n">attribute</span><span class="p">)</span>
                <span class="n">f</span> <span class="o">-=</span> <span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span></div>

<div class="viewcode-block" id="World.adddemand_point2point"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.adddemand_point2point">[docs]</a>    <span class="k">def</span> <span class="nf">adddemand_point2point</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x_orig</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">,</span> <span class="n">x_dest</span><span class="p">,</span> <span class="n">y_dest</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">flow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">volume</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate vehicles by specifying time-dependent origin-destination demand using coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_orig : float</span>
<span class="sd">            The x-coordinate of the origin.</span>
<span class="sd">        y_orig : float</span>
<span class="sd">            The y-coordinate of the origin.</span>
<span class="sd">        x_dest : float</span>
<span class="sd">            The x-coordinate of the destination.</span>
<span class="sd">        y_dest : float</span>
<span class="sd">            The y-coordinate of the destination.</span>
<span class="sd">        t_start : float</span>
<span class="sd">            The start time for the demand in seconds.</span>
<span class="sd">        t_end : float</span>
<span class="sd">            The end time for the demand in seconds.</span>
<span class="sd">        flow : float, optional</span>
<span class="sd">            The flow rate from the origin to the destination in vehicles per second.</span>
<span class="sd">        volume: float, optional</span>
<span class="sd">            The demand volume from the origin to the destination. If volume is specified, the flow is ignored.</span>
<span class="sd">        attribute : any, optinonal</span>
<span class="sd">            Additional (meta) attributes defined by users.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">orig</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_nearest_node</span><span class="p">(</span><span class="n">x_orig</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">)</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_nearest_node</span><span class="p">(</span><span class="n">x_dest</span><span class="p">,</span> <span class="n">y_dest</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">adddemand</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span></div>

<div class="viewcode-block" id="World.adddemand_area2area"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.adddemand_area2area">[docs]</a>    <span class="k">def</span> <span class="nf">adddemand_area2area</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x_orig</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">,</span>  <span class="n">radious_orig</span><span class="p">,</span> <span class="n">x_dest</span><span class="p">,</span> <span class="n">y_dest</span><span class="p">,</span> <span class="n">radious_dest</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">flow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">volume</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate vehicles by specifying time-dependent origin-destination demand by specifying circular areas.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_orig : float</span>
<span class="sd">            The x-coordinate of the center of the origin area.</span>
<span class="sd">        y_orig : float</span>
<span class="sd">            The y-coordinate of the center of the origin area.</span>
<span class="sd">        radious_orig : float</span>
<span class="sd">            The radious of the origin area. Note that too large radious may generate too sparse demand that is rounded to zero.</span>
<span class="sd">        x_dest : float</span>
<span class="sd">            The x-coordinate of the center of the destination area.</span>
<span class="sd">        y_dest : float</span>
<span class="sd">            The y-coordinate of the center of the destination area.</span>
<span class="sd">        radious_dest : float</span>
<span class="sd">            The radious of the destination area.</span>
<span class="sd">        t_start : float</span>
<span class="sd">            The start time for the demand in seconds.</span>
<span class="sd">        t_end : float</span>
<span class="sd">            The end time for the demand in seconds.</span>
<span class="sd">        flow : float, optional</span>
<span class="sd">            The flow rate from the origin to the destination in vehicles per second.</span>
<span class="sd">        volume: float, optional</span>
<span class="sd">            The demand volume from the origin to the destination. If volume is specified, the flow is ignored.</span>
<span class="sd">        attribute : any, optinonal</span>
<span class="sd">            Additional (meta) attributes defined by users.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">origs</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_nodes_in_area</span><span class="p">(</span><span class="n">x_orig</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">,</span> <span class="n">radious_orig</span><span class="p">)</span>
        <span class="n">dests</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_nodes_in_area</span><span class="p">(</span><span class="n">x_dest</span><span class="p">,</span> <span class="n">y_dest</span><span class="p">,</span> <span class="n">radious_dest</span><span class="p">)</span>

        <span class="n">origs_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dests_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">origs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">outlinks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">origs_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dests</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">inlinks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dests_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">origs</span> <span class="o">=</span> <span class="n">origs_new</span>
        <span class="n">dests</span> <span class="o">=</span> <span class="n">dests_new</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">origs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">origs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">get_nearest_node</span><span class="p">(</span><span class="n">x_orig</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dests</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">get_nearest_node</span><span class="p">(</span><span class="n">x_dest</span><span class="p">,</span> <span class="n">y_dest</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">flow</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">flow</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">origs</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dests</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">volume</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">volume</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">origs</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dests</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">origs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dests</span><span class="p">:</span>
                <span class="n">W</span><span class="o">.</span><span class="n">adddemand</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="World.finalize_scenario"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.finalize_scenario">[docs]</a>    <span class="k">def</span> <span class="nf">finalize_scenario</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finalizes the settings and preparations for the simulation scenario execution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tmax : float, optional</span>
<span class="sd">            The maximum simulation time. If not provided, it will be determined based on the departure times of the vehicles.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function automatically called by `exec_simulation()` if it has not been called manually.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">TMAX</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tmax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tmax</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">veh</span><span class="o">.</span><span class="n">departure_time</span><span class="o">*</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span> <span class="o">&gt;</span> <span class="n">tmax</span><span class="p">:</span>
                        <span class="n">tmax</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">departure_time</span><span class="o">*</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>
                <span class="n">W</span><span class="o">.</span><span class="n">TMAX</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmax</span><span class="o">//</span><span class="mi">1800</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">1800</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">W</span><span class="o">.</span><span class="n">TMAX</span> <span class="o">=</span> <span class="n">tmax</span>    <span class="c1">#s</span>

        <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#timestep</span>
        <span class="n">W</span><span class="o">.</span><span class="n">TIME</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#s</span>

        <span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">Q_AREA</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">EULAR_DT</span><span class="p">)))</span>
        <span class="n">W</span><span class="o">.</span><span class="n">K_AREA</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">EULAR_DT</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
            <span class="n">l</span><span class="o">.</span><span class="n">init_after_tmax_fix</span><span class="p">()</span>

        <span class="c1">#隣接行列の生成</span>
        <span class="n">W</span><span class="o">.</span><span class="n">ROUTECHOICE</span> <span class="o">=</span> <span class="n">RouteChoice</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">ADJ_MAT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)])</span>
        <span class="n">W</span><span class="o">.</span><span class="n">ADJ_MAT_LINKS</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#リンクオブジェクトが入った隣接行列（的な辞書）</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">link</span><span class="o">.</span><span class="n">start_node</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">W</span><span class="o">.</span><span class="n">ADJ_MAT</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">W</span><span class="o">.</span><span class="n">ADJ_MAT_LINKS</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">link</span>

        <span class="n">W</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">Analyzer</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>

        <span class="n">W</span><span class="o">.</span><span class="n">finalized</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1">## 問題規模表示</span>
        <span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;simulation setting:&quot;</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; scenario name:&quot;</span><span class="p">,</span> <span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; simulation duration:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; number of vehicles:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span><span class="p">)</span><span class="o">*</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">,</span> <span class="s2">&quot;veh&quot;</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; total road length:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">length</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">]),</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; time discret. width:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; platoon size:</span><span class="se">\t\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">,</span> <span class="s2">&quot;veh&quot;</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; number of timesteps:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; number of platoons:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span><span class="p">))</span>
        <span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; number of links:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">))</span>
        <span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; number of nodes:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">))</span>
        <span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; setup time:</span><span class="se">\t\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">W</span><span class="o">.</span><span class="n">world_start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>

        <span class="n">W</span><span class="o">.</span><span class="n">sim_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;simulating...&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="World.exec_simulation"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.exec_simulation">[docs]</a>    <span class="k">def</span> <span class="nf">exec_simulation</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">until_t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">duration_t</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the main loop of the simulation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        until_t : float or None, optional</span>
<span class="sd">            The time until the simulation is to be executed in seconds. If both `until_t` and `duration_t` are None, the simulation is executed until the end. Default is None.</span>
<span class="sd">        duration_t : float or None, optional</span>
<span class="sd">            The duration for which the simulation is to be executed in seconds. If both `until_t` and `duration_t` are None, the simulation is executed until the end. Default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Returns 1 if the simulation is finished, 0 otherwise.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The function executes the main simulation loop that update links, nodes, and vehicles for each time step.</span>
<span class="sd">        It also performs route search and updates the route preference for vehicles at specified intervals.</span>
<span class="sd">        The simulation is executed until the end time is reached or until the maximum simulation time is exceeded.</span>
<span class="sd">        The nodes, links, and vehicles must be defined before calling this function.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#シミュレーションのメインループを回す</span>


        <span class="c1">#シナリオ未確定であればここで確定</span>
        <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">finalized</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">W</span><span class="o">.</span><span class="n">finalize_scenario</span><span class="p">()</span>

        <span class="c1">#時間決定</span>
        <span class="n">start_ts</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">until_t</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">until_t</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">duration_t</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end_ts</span> <span class="o">=</span> <span class="n">start_ts</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">duration_t</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end_ts</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span>
        <span class="k">if</span> <span class="n">end_ts</span> <span class="o">&gt;</span> <span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span><span class="p">:</span>
            <span class="n">end_ts</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span>

        <span class="c1">#W.print(f&quot;simulating: from t = {start_ts*W.DELTAT} to {(end_ts-1)*W.DELTAT} s...&quot;)</span>

        <span class="k">if</span> <span class="n">start_ts</span> <span class="o">==</span> <span class="n">end_ts</span> <span class="o">==</span> <span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">print_mode</span> <span class="ow">and</span> <span class="n">W</span><span class="o">.</span><span class="n">show_progress</span><span class="p">:</span>
                <span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">show_simulation_progress</span><span class="p">()</span>
            <span class="n">W</span><span class="o">.</span><span class="n">simulation_terminated</span><span class="p">()</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="c1">#シミュレーション終わり</span>
        <span class="k">if</span> <span class="n">end_ts</span> <span class="o">&lt;</span> <span class="n">start_ts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;exec_simulation error: Simulation duration is negative. Check until_t or duration_t&quot;</span><span class="p">)</span>

        <span class="c1">#メインループ</span>
        <span class="k">for</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_ts</span><span class="p">,</span> <span class="n">end_ts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;      time| # of vehicles| ave speed| computation time&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">show_simulation_progress</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
                <span class="n">link</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
                <span class="n">node</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">transfer</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_RUNNING</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">veh</span><span class="o">.</span><span class="n">carfollow</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_LIVING</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_LIVING</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">%</span> <span class="n">W</span><span class="o">.</span><span class="n">DELTAT_ROUTE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">W</span><span class="o">.</span><span class="n">ROUTECHOICE</span><span class="o">.</span><span class="n">route_search_all</span><span class="p">(</span><span class="n">noise</span><span class="o">=</span><span class="n">W</span><span class="o">.</span><span class="n">DUO_NOISE</span><span class="p">)</span>
                <span class="n">W</span><span class="o">.</span><span class="n">ROUTECHOICE</span><span class="o">.</span><span class="n">homogeneous_DUO_update</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_LIVING</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">veh</span><span class="o">.</span><span class="n">route_pref_update</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="n">W</span><span class="o">.</span><span class="n">DUO_UPDATE_WEIGHT</span><span class="p">)</span>

            <span class="n">W</span><span class="o">.</span><span class="n">TIME</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>

            <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">print_mode</span> <span class="ow">and</span> <span class="n">W</span><span class="o">.</span><span class="n">show_progress</span> <span class="ow">and</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">%</span><span class="n">W</span><span class="o">.</span><span class="n">show_progress_deltat_timestep</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">show_simulation_progress</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">==</span> <span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">print_mode</span> <span class="ow">and</span> <span class="n">W</span><span class="o">.</span><span class="n">show_progress</span><span class="p">:</span>
                <span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">show_simulation_progress</span><span class="p">()</span>
            <span class="n">W</span><span class="o">.</span><span class="n">simulation_terminated</span><span class="p">()</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="c1">#まだ終わってない</span></div>

<div class="viewcode-block" id="World.check_simulation_ongoing"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.check_simulation_ongoing">[docs]</a>    <span class="k">def</span> <span class="nf">check_simulation_ongoing</span><span class="p">(</span><span class="n">W</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether the simulation is has not reached its final time.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Returns 1 if the simulation is ongoing and has not reached its final time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#シミュレーションが進行中か判定</span>
        <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">finalized</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">&lt;</span> <span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span><span class="o">-</span><span class="mi">1</span></div>

<div class="viewcode-block" id="World.simulation_terminated"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.simulation_terminated">[docs]</a>    <span class="k">def</span> <span class="nf">simulation_terminated</span><span class="p">(</span><span class="n">W</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Postprocessing after simulation finished</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; simulation finished&quot;</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">basic_analysis</span><span class="p">()</span></div>

<div class="viewcode-block" id="World.get_node"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.get_node">[docs]</a>    <span class="k">def</span> <span class="nf">get_node</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a Node instance by name or object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        node : str or Node object</span>
<span class="sd">            The name of the node or the Node object itself.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Node object</span>
<span class="sd">            The found Node object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Node</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">node</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">n</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">node</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">n</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&#39; is not Node in this World&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="World.get_link"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.get_link">[docs]</a>    <span class="k">def</span> <span class="nf">get_link</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">link</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a Link instance by name or object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        link : str or Link object</span>
<span class="sd">            The name of the link or the Link object itself.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Link object</span>
<span class="sd">            The found Link object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Link</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">link</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">link</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">l</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">link</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">l</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">link</span><span class="si">}</span><span class="s2">&#39; is not Link in this World&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="World.get_nearest_node"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.get_nearest_node">[docs]</a>    <span class="k">def</span> <span class="nf">get_nearest_node</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the nearest node to the given coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : float</span>
<span class="sd">            The x-coordinate.</span>
<span class="sd">        y : float</span>
<span class="sd">            The y-coordinate.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        object</span>
<span class="sd">            The nearest Node object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">min_dist</span> <span class="o">=</span> <span class="mf">1e10</span>
        <span class="n">nearest_node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">y</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">min_dist</span><span class="p">:</span>
                <span class="n">min_dist</span> <span class="o">=</span> <span class="n">dist</span>
                <span class="n">nearest_node</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">return</span> <span class="n">nearest_node</span></div>

<div class="viewcode-block" id="World.get_nodes_in_area"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.get_nodes_in_area">[docs]</a>    <span class="k">def</span> <span class="nf">get_nodes_in_area</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the nodes in the area defined by the center coordinates and radius.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : float</span>
<span class="sd">            The x-coordinate of the center.</span>
<span class="sd">        y : float</span>
<span class="sd">            The y-coordinate of the center.</span>
<span class="sd">        r : float</span>
<span class="sd">            The radius of the area.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of Node objects in the area.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">y</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nodes</span></div>

<div class="viewcode-block" id="World.load_scenario_from_csv"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.load_scenario_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">load_scenario_from_csv</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">fname_node</span><span class="p">,</span> <span class="n">fname_link</span><span class="p">,</span> <span class="n">fname_demand</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a scenario from CSV files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname_node : str</span>
<span class="sd">            The file name of the CSV file containing node data.</span>
<span class="sd">        fname_link : str</span>
<span class="sd">            The file name of the CSV file containing link data.</span>
<span class="sd">        fname_demand : str</span>
<span class="sd">            The file name of the CSV file containing demand data.</span>
<span class="sd">        tmax : float or None, optional</span>
<span class="sd">            The maximum simulation time in seconds, default is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">W</span><span class="o">.</span><span class="n">generate_Nodes_from_csv</span><span class="p">(</span><span class="n">fname_node</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">generate_Links_from_csv</span><span class="p">(</span><span class="n">fname_link</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">generate_demand_from_csv</span><span class="p">(</span><span class="n">fname_demand</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">W</span><span class="o">.</span><span class="n">TMAX</span> <span class="o">=</span> <span class="n">tmax</span></div>

<div class="viewcode-block" id="World.generate_Nodes_from_csv"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.generate_Nodes_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">generate_Nodes_from_csv</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate nodes in the network from a CSV file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : str</span>
<span class="sd">            The file name of the CSV file containing node data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
                    <span class="n">W</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span></div>

<div class="viewcode-block" id="World.generate_Links_from_csv"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.generate_Links_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">generate_Links_from_csv</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate links in the network from a CSV file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : str</span>
<span class="sd">            The file name of the CSV file containing link data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;length&quot;</span><span class="p">:</span>
                    <span class="n">W</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">length</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">free_flow_speed</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="n">jam_density</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="n">merge_priority</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">6</span><span class="p">]))</span></div>

<div class="viewcode-block" id="World.generate_demand_from_csv"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.generate_demand_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">generate_demand_from_csv</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate demand in the network from a CSV file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : str</span>
<span class="sd">            The file name of the CSV file containing demand data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;start_t&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">W</span><span class="o">.</span><span class="n">adddemand</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">W</span><span class="o">.</span><span class="n">adddemand</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span></div>

<div class="viewcode-block" id="World.on_time"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.on_time">[docs]</a>    <span class="k">def</span> <span class="nf">on_time</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the current time step is close to the specified time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : float</span>
<span class="sd">            The specified time in seconds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            Returns True if the current time step is close to the specified time, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    <span class="c1">#@catch_exceptions_and_warn()</span>
<div class="viewcode-block" id="World.show_network"><a class="viewcode-back" href="../../uxsim.html#uxsim.World.show_network">[docs]</a>    <span class="k">def</span> <span class="nf">show_network</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">left_handed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">network_font_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualizes the entire transportation network shape.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">node_size</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">network_font_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">network_font_size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">y</span>
            <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">y</span>
            <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">y2</span><span class="p">)</span><span class="o">*</span><span class="mf">0.05</span><span class="p">,</span> <span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.05</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">left_handed</span><span class="p">:</span>
                <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span> <span class="o">=</span> <span class="o">-</span><span class="n">vx</span><span class="p">,</span> <span class="o">-</span><span class="n">vy</span>
            <span class="c1">#簡略モード</span>
            <span class="n">xmid1</span><span class="p">,</span> <span class="n">ymid1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x1</span><span class="o">+</span><span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vx</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">y1</span><span class="o">+</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vy</span>
            <span class="n">xmid2</span><span class="p">,</span> <span class="n">ymid2</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vx</span><span class="p">,</span> <span class="p">(</span><span class="n">y1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vy</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">xmid1</span><span class="p">,</span> <span class="n">xmid2</span><span class="p">,</span> <span class="n">x2</span><span class="p">],</span> <span class="p">[</span><span class="n">y1</span><span class="p">,</span> <span class="n">ymid1</span><span class="p">,</span> <span class="n">ymid2</span><span class="p">,</span> <span class="n">y2</span><span class="p">],</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">solid_capstyle</span><span class="o">=</span><span class="s2">&quot;butt&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">network_font_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xmid1</span><span class="p">,</span> <span class="n">ymid1</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">network_font_size</span><span class="p">)</span>
        <span class="n">maxx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">minx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">maxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">miny</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">buffx</span><span class="p">,</span> <span class="n">buffy</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxx</span><span class="o">-</span><span class="n">minx</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="n">maxy</span><span class="o">-</span><span class="n">miny</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span>
        <span class="k">if</span> <span class="n">buffx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">buffx</span> <span class="o">=</span> <span class="n">buffy</span>
        <span class="k">if</span> <span class="n">buffy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">buffy</span> <span class="o">=</span> <span class="n">buffx</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">minx</span><span class="o">-</span><span class="n">buffx</span><span class="p">,</span> <span class="n">maxx</span><span class="o">+</span><span class="n">buffx</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">miny</span><span class="o">-</span><span class="n">buffy</span><span class="p">,</span> <span class="n">maxy</span><span class="o">+</span><span class="n">buffy</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023 Toru Seo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>